<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>2026æŒªå¨å†°å³¶ä¹‹æ—…</title>
  <meta name="referrer" content="no-referrer">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="2026åŒ—æ­è¡Œ">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#f0f9ff">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="https://img.icons8.com/color/180/snowflake.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* --- Base Variables & Reset --- */
    :root {
      --primary: #0ea5e9;
      --primary-dark: #0284c7;
      --bg-gradient-start: #f0f9ff;
      --bg-gradient-end: #e0f2fe;
      --glass-bg: rgba(255, 255, 255, 0.75);
      --glass-border: rgba(255, 255, 255, 0.6);
      --blur: 20px;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }

    html, body {
      height: 100dvh; /* Dynamic height for mobile browsers */
      width: 100%;
      overflow: hidden;
      font-family: 'Inter', 'Noto Sans TC', -apple-system, sans-serif;
      background-color: var(--bg-gradient-start);
      color: #0f172a;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      -webkit-user-select: none;
    }

    /* --- Layout Structure --- */
    #app {
      height: 100%;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* Background Animation */
    .animated-bg {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
      background: linear-gradient(180deg, #f0f9ff 0%, #e0f2fe 100%);
    }
    .animated-bg::before {
      content: ''; position: absolute; top: -20%; right: -20%; width: 80%; height: 60%;
      background: radial-gradient(circle, rgba(186, 230, 253, 0.6) 0%, rgba(255,255,255,0) 70%);
      filter: blur(60px); opacity: 0.8;
    }

    /* --- Scroll Area --- */
    .scrollable-content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-y: contain; /* Prevents pull-to-refresh on body */
      padding-top: 0;
      padding-bottom: calc(90px + var(--safe-bottom)); /* Clear bottom nav */
      touch-action: pan-y;
    }

    /* --- Components: Glass Card --- */
    .ios-card {
      background: var(--glass-bg);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(148, 163, 184, 0.1);
      transition: transform 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    .ios-card:active { transform: scale(0.985); }

    /* --- Components: Inputs --- */
    .ios-input {
      background: rgba(255, 255, 255, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.8);
      border-radius: 16px;
      color: #334155;
      font-weight: 600;
      transition: all 0.3s;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.02);
    }
    .ios-input:focus {
      background: #fff;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1);
      outline: none;
    }
    .ios-input::placeholder { color: #94a3b8; font-weight: 500; }

    /* --- Components: Buttons --- */
    .btn-primary {
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
      color: white;
      border: none;
      box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3);
      position: relative; overflow: hidden;
    }
    .btn-primary::after {
        content: ''; position: absolute; top:0; left:0; width:100%; height:100%;
        background: linear-gradient(to bottom, rgba(255,255,255,0.2), transparent);
        pointer-events: none;
    }
    
    /* --- Bottom Navigation --- */
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; width: 100%;
      height: calc(65px + var(--safe-bottom));
      padding-bottom: var(--safe-bottom);
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border-top: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 -5px 20px rgba(0,0,0,0.03);
      display: flex; justify-content: space-around; align-items: center;
      z-index: 40;
    }
    .nav-item {
      flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
      height: 100%; color: #94a3b8; gap: 4px; transition: color 0.3s;
    }
    .nav-item svg { width: 24px; height: 24px; stroke-width: 2.5; transition: all 0.3s; }
    .nav-item span { font-size: 10px; font-weight: 700; letter-spacing: 0.5px; }
    .nav-item.active { color: var(--primary-dark); }
    .nav-item.active svg { transform: translateY(-2px); stroke-width: 3; filter: drop-shadow(0 4px 6px rgba(14,165,233,0.3)); }

    /* --- Header & Top Area --- */
    .header-sticky {
      position: sticky; top: 0; z-index: 30;
      padding-top: calc(10px + var(--safe-top));
      padding-bottom: 12px;
      background: rgba(240, 249, 255, 0.92);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255,255,255,0.4);
      transition: all 0.3s;
    }

    /* --- Pull Indicator --- */
    .pull-indicator {
      height: 0; overflow: hidden; display: flex; justify-content: center; align-items: flex-end;
      color: #64748b; font-size: 0.85rem; font-weight: 600; padding-bottom: 8px;
    }

    /* --- Horizontal Scroll Snap --- */
    .snap-x-mandatory { scroll-snap-type: x mandatory; }
    .snap-center { scroll-snap-align: center; }
    .hide-scroll::-webkit-scrollbar { display: none; }

    /* --- Categories & Tags --- */
    .cat-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
    
    /* --- Modal Transitions --- */
    .modal-enter-active, .modal-leave-active { transition: opacity 0.25s ease; }
    .modal-enter-from, .modal-leave-to { opacity: 0; }
    .modal-enter-active .modal-card, .modal-leave-active .modal-card { transition: transform 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .modal-enter-from .modal-card, .modal-leave-to .modal-card { transform: scale(0.92) translateY(30px); opacity: 0; }

    /* --- Utilities --- */
    .text-shadow { text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .allow-select { user-select: text; -webkit-user-select: text; cursor: auto; }
    .truncate-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    
    /* Skeleton Loading */
    .skeleton {
        background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.5) 50%, rgba(255,255,255,0) 100%);
        background-size: 200% 100%; animation: shimmer 2s infinite;
        background-color: #e2e8f0;
    }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    /* Pending Sync Style */
    .pending-item { border: 2px dashed #f59e0b !important; opacity: 0.9; }

    /* Image Viewer */
    .img-viewer-overlay {
        position: fixed; inset: 0; z-index: 100;
        background: #000; display: flex; flex-direction: column;
        justify-content: center; align-items: center;
        touch-action: none;
    }
    .img-viewer-img { max-width: 100%; max-height: 100%; object-fit: contain; }
  </style>
</head>
<body>

<div class="animated-bg"></div>

<div id="app">
  
  <div class="scrollable-content" ref="scrollContainer">
    
    <div class="pull-indicator" :style="{ height: pullDistance + 'px' }">
      <span v-if="pullDistance > 20" class="flex items-center gap-2">
        <svg class="w-4 h-4 animate-spin" v-if="isPullRefreshing" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        {{ refreshText }}
      </span>
    </div>

    <div class="header-sticky px-6 swipe-protected">
      <div class="flex justify-between items-start">
        <div>
          <h1 class="text-2xl font-black text-slate-800 tracking-tight">2026 æŒªå¨å†°å³¶</h1>
          <div class="flex items-center gap-2 mt-1">
             <span class="text-xs font-bold text-sky-600 bg-sky-100 px-2 py-0.5 rounded-full tracking-wider">{{ tripStatus || 'è¦åŠƒä¸­' }}</span>
             <span v-if="!isOnline" class="text-[10px] font-bold bg-slate-200 text-slate-500 px-2 py-0.5 rounded-full">OFFLINE</span>
          </div>
        </div>
        <div class="text-right">
             <button v-if="isSyncing" class="bg-emerald-500 text-white px-2.5 py-1 rounded-full text-[10px] font-bold shadow-md flex items-center gap-1 ml-auto mb-1 animate-pulse">
                <span class="w-1.5 h-1.5 bg-white rounded-full animate-bounce"></span> åŒæ­¥ä¸­
            </button>
            <button v-else-if="syncQueue.length > 0" @click="confirmClearSync" class="bg-amber-500 text-white px-2.5 py-1 rounded-full text-[10px] font-bold shadow-md flex items-center gap-1 ml-auto mb-1">
                {{ syncQueue.length }} å¾…ä¸Šå‚³
            </button>
            <div class="text-lg font-black text-slate-700 font-mono">{{ todayDate.slice(5) }}</div>
            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{{ todayWeekday }}</div>
        </div>
      </div>
    </div>

    <div class="p-4 min-h-screen">
      <Transition name="modal" mode="out-in">
        
        <div v-if="tab==='itinerary'" key="itinerary">
            
          <div ref="dateContainer" class="flex overflow-x-auto gap-2 pb-4 pt-1 mb-2 hide-scroll snap-x-mandatory swipe-protected">
            <button v-for="d in tripDates" :key="d.date" :id="'date-btn-' + d.date" @click="selectDate(d.date)"
                    class="snap-center flex-shrink-0 flex flex-col items-center justify-center w-14 h-16 rounded-2xl border transition-all duration-300"
                    :class="selDate===d.date 
                      ? 'bg-sky-500 text-white border-sky-500 shadow-lg shadow-sky-200 scale-105' 
                      : 'bg-white/60 border-white/40 text-slate-400 backdrop-blur-sm'">
              <span class="text-[10px] font-bold uppercase opacity-80">{{ new Date(d.date).toLocaleString('en-us',{weekday:'short'}) }}</span>
              <span class="text-lg font-black leading-none mt-0.5">{{ d.short.split('/')[1] }}</span>
            </button>
          </div>

          <div class="flex justify-between items-center mb-4 px-1">
             <span class="text-sm font-bold text-slate-500">{{ getDayInfo(selDate) }}</span>
             <button @click="openAddItin" class="bg-slate-800 text-white w-8 h-8 rounded-full flex items-center justify-center shadow-lg active:scale-90 transition text-lg font-light swipe-protected">+</button>
          </div>

          <div v-if="isLoading && itinerary.length===0" class="space-y-4">
             <div v-for="i in 4" class="ios-card h-24 skeleton border-0"></div>
          </div>

          <div v-else class="space-y-5 pl-2 relative">
             <div class="absolute left-[5.5rem] top-4 bottom-4 w-0.5 bg-sky-100 rounded-full z-0"></div>

             <div v-for="evt in getEvents(selDate)" :key="evt.row" 
                  class="relative z-10 flex gap-4 group"
                  :class="{'opacity-60': isItemPending(evt.row)}">
                
                <div class="w-16 pt-3 text-right flex-shrink-0 flex flex-col items-end">
                   <div class="font-black text-slate-700 font-mono text-sm">{{ evt.startTime }}</div>
                   <div v-if="evt.endTime" class="text-[10px] text-slate-400 font-medium mt-0.5">{{ evt.endTime }}</div>
                </div>

                <div class="flex-1 min-w-0 ios-card p-4 relative overflow-hidden bg-white/80" 
                     :class="isItemPending(evt.row) ? 'pending-item' : ''">
                   
                   <div class="absolute top-0 left-0 w-1 h-full" :class="{
                       'bg-blue-500': evt.category==='äº¤é€š',
                       'bg-yellow-500': evt.category==='ä½å®¿',
                       'bg-purple-500': evt.category==='æ™¯é»',
                       'bg-orange-500': evt.category==='é£²é£Ÿ',
                       'bg-slate-400': evt.category==='å…¶ä»–'
                   }"></div>

                   <div class="pl-2">
                       <div class="flex justify-between items-start mb-1">
                           <span v-if="!evt.link" class="font-bold text-slate-800 text-[15px] leading-snug">{{ evt.title }}</span>
                           <a v-else :href="evt.link" target="_blank" class="font-bold text-sky-700 underline decoration-sky-300 decoration-2 underline-offset-2 text-[15px] leading-snug truncate-2 swipe-protected">{{ evt.title }}</a>
                       </div>
                       
                       <div v-if="evt.location" class="flex items-center gap-1 mb-2">
                           <span class="text-xs text-slate-500 truncate">ğŸ“ {{ evt.location }}</span>
                           <a :href="'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(evt.location)" target="_blank" class="text-[9px] bg-slate-100 px-1.5 py-0.5 rounded text-slate-600 font-bold swipe-protected">MAP</a>
                       </div>

                       <div v-if="evt.imgUrl" class="mb-2 rounded-lg overflow-hidden h-32 w-full border border-slate-100 relative shadow-inner group-image" @click.stop="viewImage(evt.imgUrl)">
                           <img :src="evt.imgUrl" class="w-full h-full object-cover">
                           <div class="absolute bottom-1 right-1 bg-black/50 text-white text-[9px] px-1.5 rounded backdrop-blur-md">IMG</div>
                       </div>

                       <p v-if="evt.note" class="text-sm text-slate-600 whitespace-pre-wrap leading-relaxed allow-select" @click.stop>{{ evt.note }}</p>

                       <div class="flex justify-end gap-3 mt-3 pt-2 border-t border-slate-100 border-dashed swipe-protected">
                           <button @click.stop="openEditItin(evt)" class="text-[10px] font-bold text-slate-400 hover:text-sky-600 px-2 py-1">ç·¨è¼¯</button>
                           <button @click.stop="deleteItin(evt)" class="text-[10px] font-bold text-slate-400 hover:text-red-500 px-2 py-1">åˆªé™¤</button>
                       </div>
                   </div>
                </div>
             </div>
             
             <div v-if="getEvents(selDate).length === 0" class="text-center py-10 opacity-50">
                 <div class="text-4xl mb-2">ğŸ”ï¸</div>
                 <div class="text-sm font-bold text-slate-400">é€™å¤©é‚„æ²’æœ‰è¡Œç¨‹</div>
                 <button @click="openAddItin" class="mt-4 text-sky-500 font-bold text-sm swipe-protected">+ é»æ“Šæ–°å¢</button>
             </div>
          </div>
        </div>

        <div v-else-if="tab==='expense'" key="expense">
          
          <div class="ios-card p-5 mb-6 bg-white/90 swipe-protected shadow-lg relative overflow-hidden">
             <div class="absolute top-0 right-0 w-24 h-24 bg-blue-500/5 rounded-bl-full pointer-events-none"></div>

             <div class="space-y-4 relative z-10">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-black text-slate-800">è¨˜å¸³</h2>
                    <div class="text-[10px] font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded-md">{{ newExp.currency }} â‰ˆ {{ (rates[newExp.currency] || 1).toFixed(2) }}</div>
                </div>

                <div class="relative">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-sm">{{ newExp.currency }}</span>
                    <input type="number" v-model="newExp.amount" placeholder="0" class="w-full bg-slate-50 border-none rounded-xl py-4 pl-14 pr-4 text-3xl font-black text-slate-800 outline-none focus:ring-2 focus:ring-sky-200 transition-all font-mono">
                </div>
                <div v-if="newExp.amount && newExp.currency !== 'NTD'" class="text-right text-xs font-bold text-slate-400 -mt-2">
                    â‰ˆ NT$ {{ formatNumber(Math.round(newExp.amount * rates[newExp.currency])) }}
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <select v-model="newExp.item" class="ios-input p-3 text-sm appearance-none"><option value="" disabled selected>é …ç›®</option><option>æ—©é¤</option><option>åˆé¤</option><option>æ™šé¤</option><option>é›¶é£Ÿ</option><option>ä½å®¿</option><option>äº¤é€šï¼ˆæ©Ÿç¥¨ï¼‰</option><option>äº¤é€šï¼ˆç§Ÿè»Šï¼‰</option><option>äº¤é€šï¼ˆåœè»Šè²»ï¼‰</option><option>äº¤é€šï¼ˆæ²¹éŒ¢ï¼‰</option><option>ç´€å¿µå“</option><option>é–€ç¥¨</option><option>å…¶ä»–</option></select>
                    <select v-model="newExp.payer" class="ios-input p-3 text-sm appearance-none"><option value="" disabled selected>èª°ä»˜çš„</option><option>å®¶é½Š</option><option>äº­ç©</option><option>åª½åª½</option></select>
                    <select v-model="newExp.payment" class="ios-input p-3 text-sm appearance-none"><option value="" disabled selected>æ”¯ä»˜æ–¹å¼</option><option>ç¾é‡‘</option><option>ä¿¡ç”¨å¡-åœ‹æ³°</option><option>ä¿¡ç”¨å¡-æ°¸è±</option><option>ä¿¡ç”¨å¡-å…ƒå¤§</option></select>
                    <select v-model="newExp.location" class="ios-input p-3 text-sm appearance-none"><option value="" disabled selected>åœ°é»</option><option>å°ç£</option><option>æŒªå¨</option><option>å†°å³¶</option><option>è‹±åœ‹</option><option>æœæ‹œ</option></select>
                    <select v-model="newExp.currency" class="ios-input p-3 text-sm appearance-none col-span-2 text-center font-mono text-sky-600 bg-sky-50"><option>NTD</option><option>NOK</option><option>ISK</option><option>EUR</option><option>GBP</option><option>AED</option></select>
                </div>
                
                <input v-model="newExp.note" placeholder="å‚™è¨»..." class="w-full ios-input p-3 text-sm">

                <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-bold text-slate-400 uppercase">åˆ†æ”¤å°è±¡</span>
                        <button @click="toggleSelectAll" class="text-[10px] text-sky-600 font-bold">å…¨é¸</button>
                    </div>
                    <div class="flex gap-2">
                        <div v-for="m in members" :key="m" @click="toggleMember(m)" 
                             class="flex-1 py-2 text-center rounded-lg text-xs font-bold border transition-all cursor-pointer"
                             :class="newExp.involved.includes(m) ? 'bg-sky-500 text-white border-sky-500 shadow-md transform scale-105' : 'bg-white text-slate-400 border-slate-200'">
                             {{ m }}
                        </div>
                    </div>
                </div>

                <button @click="submitExp" class="w-full btn-primary py-4 rounded-xl font-bold text-lg tracking-wide shadow-lg active:scale-95 transition-transform">ç¢ºèªè¨˜å¸³</button>
             </div>
          </div>
        </div>

        <div v-else-if="tab==='analysis'" key="analysis">
           
           <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl p-6 text-white shadow-xl mb-6 relative overflow-hidden ring-1 ring-white/20">
              <div class="absolute -top-10 -right-10 w-48 h-48 bg-sky-500 opacity-20 rounded-full blur-3xl"></div>
              <div class="absolute bottom-0 left-0 w-full h-1/2 bg-gradient-to-t from-black/40 to-transparent"></div>
              
              <div class="relative z-10">
                  <div class="flex justify-between items-start mb-6">
                      <div>
                          <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">BUDGET (å®¶é½Š+äº­ç©)</div>
                          <div class="text-3xl font-black font-mono tracking-tighter">NT$ {{ formatNumber(Math.round(500000 - publicSpent)) }}</div>
                      </div>
                      <div class="bg-white/10 backdrop-blur-md px-3 py-1 rounded-full border border-white/10">
                          <span class="text-xs font-bold text-sky-300">{{ Math.round((publicSpent/500000)*100) }}%</span>
                      </div>
                  </div>

                  <div class="h-1.5 bg-slate-700/50 rounded-full overflow-hidden mb-2">
                      <div class="h-full bg-gradient-to-r from-sky-400 to-blue-500 shadow-[0_0_10px_rgba(56,189,248,0.5)] transition-all duration-1000" :style="{width: Math.min((publicSpent/500000)*100, 100) + '%'}"></div>
                  </div>
                  <div class="flex justify-between text-[10px] font-bold text-slate-400 font-mono">
                      <span>USED: {{ formatNumber(Math.round(publicSpent)) }}</span>
                      <span>TOTAL: 500,000</span>
                  </div>
              </div>
           </div>

           <div class="ios-card p-4 mb-6">
               <h3 class="font-bold text-slate-700 text-sm mb-4 pl-1">æ¶ˆè²»åˆ†ä½ˆ</h3>
               <div class="h-48 relative">
                   <div v-if="chartBusy" class="absolute inset-0 flex items-center justify-center text-xs text-slate-400">Loading...</div>
                   <canvas id="expenseChart"></canvas>
               </div>
           </div>
            
           <div class="flex items-center justify-between mb-3 px-1 swipe-protected">
               <h3 class="font-bold text-slate-800 text-lg">è¿‘æœŸæ¶ˆè²»</h3>
               <div class="flex gap-2">
                   <button @click="showFilterMenu=!showFilterMenu" class="bg-white px-3 py-1.5 rounded-full text-xs font-bold text-sky-600 shadow-sm border border-slate-100">
                       {{ showFilterMenu ? 'æ”¶èµ·' : 'ç¯©é¸' }}
                   </button>
                   <button @click="openRateModal" class="bg-white px-3 py-1.5 rounded-full text-xs font-bold text-slate-500 shadow-sm border border-slate-100">åŒ¯ç‡</button>
               </div>
           </div>
            
           <div v-if="showFilterMenu" class="ios-card p-4 mb-4 grid grid-cols-2 gap-2 text-xs swipe-protected">
                <select v-model="filters.item" class="ios-input p-2"><option value="ALL">å…¨é …ç›®</option><option v-for="i in uniqueItems" :value="i">{{i}}</option></select>
                <select v-model="filters.payer" class="ios-input p-2"><option value="ALL">å…¨ä»˜æ¬¾äºº</option><option v-for="p in members" :value="p">{{p}}</option></select>
                <button @click="resetFilters" class="col-span-2 bg-slate-100 py-2 rounded-lg font-bold text-slate-500 mt-1">é‡ç½®</button>
           </div>

           <div class="space-y-3 pb-8">
               <div v-for="exp in filteredExpenses" :key="exp.row" 
                    class="ios-card p-3 flex justify-between items-center group active:scale-[0.99] transition-transform"
                    :class="{'pending-item': isItemPending(exp.row)}"
                    @click="openEditExp(exp)"> <div class="flex items-center gap-3 overflow-hidden">
                       <div class="w-10 h-10 rounded-full flex items-center justify-center text-lg flex-shrink-0" 
                            :class="{'bg-orange-100 text-orange-600': getItemTagClass(exp.item).includes('food'), 
                                     'bg-blue-100 text-blue-600': getItemTagClass(exp.item).includes('traffic'),
                                     'bg-yellow-100 text-yellow-600': getItemTagClass(exp.item).includes('stay'),
                                     'bg-slate-100 text-slate-600': getItemTagClass(exp.item).includes('other')}">
                           {{ getIcon(exp.item) }}
                       </div>
                       <div class="min-w-0">
                           <div class="font-bold text-slate-800 text-sm truncate">{{ exp.item }} <span v-if="exp.note" class="text-slate-400 font-normal text-xs">- {{exp.note}}</span></div>
                           <div class="text-[10px] font-bold text-slate-400 mt-0.5 flex gap-1">
                               <span>{{ exp.date.slice(5) }}</span> Â· 
                               <span>{{ exp.payer }}</span>
                               <span v-if="exp.involved.length>0" class="text-orange-400"> (åˆ†{{exp.involved.length}})</span>
                           </div>
                       </div>
                   </div>

                   <div class="text-right flex-shrink-0 pl-2">
                       <div class="font-bold text-slate-800 font-mono">{{ formatNumber(exp.amount) }} <span class="text-[10px] text-slate-400">{{ exp.currency }}</span></div>
                       <div v-if="exp.currency!=='NTD'" class="text-[9px] font-bold text-slate-400">â‰ˆ {{ formatNumber(getAmountTWD(exp)) }}</div>
                   </div>
               </div>
               <div v-if="filteredExpenses.length===0" class="text-center py-8 text-slate-400 text-sm font-bold">æ²’æœ‰ç¬¦åˆçš„ç´€éŒ„</div>
           </div>

           <div class="ios-card p-4 mb-8 bg-slate-50/50">
               <h3 class="font-bold text-slate-800 text-xs uppercase tracking-widest mb-3 border-b border-slate-200 pb-2">çµç®—å»ºè­°</h3>
               <div v-if="debts.length===0" class="text-center text-xs text-slate-400 font-bold py-2">ç›®å‰æ²’æœ‰æ¬ æ¬¾ ğŸ‰</div>
               <div v-else class="space-y-2">
                   <div v-for="d in debts" :key="d.from+d.to" class="flex justify-between items-center text-sm">
                       <div class="flex items-center gap-2">
                           <span class="font-bold text-slate-700">{{ d.from }}</span>
                           <span class="text-[10px] text-slate-400">çµ¦</span>
                           <span class="font-bold text-slate-700">{{ d.to }}</span>
                       </div>
                       <span class="font-bold text-sky-600 font-mono">{{ formatNumber(d.amount) }}</span>
                   </div>
               </div>
           </div>

        </div>

      </Transition>
    </div>
  </div>

  <div class="bottom-nav swipe-protected">
    <button @click="changeTab('itinerary')" class="nav-item" :class="{active: tab==='itinerary'}">
      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 7m0 13V7"></path></svg>
      <span>è¡Œç¨‹</span>
    </button>
    <button @click="changeTab('expense')" class="nav-item" :class="{active: tab==='expense'}">
      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"></path></svg>
      <span>è¨˜å¸³</span>
    </button>
    <button @click="changeTabToAnalysis" class="nav-item" :class="{active: tab==='analysis'}">
      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
      <span>åˆ†æ</span>
    </button>
  </div>

  <Transition name="modal">
    <div v-if="showItinModal || showExpModal || showRateModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 swipe-protected">
      <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" @click="closeAllModals"></div>
      
      <div v-if="showItinModal" class="modal-card bg-white w-full max-w-sm rounded-3xl shadow-2xl relative z-10 overflow-hidden flex flex-col max-h-[85vh]">
         <div class="px-5 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
             <h3 class="font-bold text-slate-800 text-lg">{{ isEditing ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3>
             <button @click="closeAllModals" class="text-slate-400 p-1 bg-white rounded-full shadow-sm">âœ•</button>
         </div>
         <div class="p-5 overflow-y-auto space-y-4">
             <div class="flex gap-3">
                 <div class="flex-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">é–‹å§‹</label><input type="time" v-model="itinForm.startTime" class="ios-input w-full p-3 text-center"></div>
                 <div class="flex-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">çµæŸ</label><input type="time" v-model="itinForm.endTime" class="ios-input w-full p-3 text-center"></div>
             </div>
             
             <div>
                 <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">é¡åˆ¥</label>
                 <div class="flex gap-2 mt-1 overflow-x-auto pb-1 hide-scroll">
                     <button v-for="c in ['æ™¯é»','é£²é£Ÿ','äº¤é€š','ä½å®¿','å…¶ä»–']" :key="c" @click="itinForm.category=c"
                         class="px-4 py-2 rounded-xl text-xs font-bold transition flex-shrink-0"
                         :class="itinForm.category===c ? 'bg-sky-500 text-white shadow-md' : 'bg-slate-100 text-slate-500'">{{c}}</button>
                 </div>
             </div>

             <input v-model="itinForm.title" class="ios-input w-full p-3" placeholder="è¡Œç¨‹æ¨™é¡Œ">
             <input v-model="itinForm.location" class="ios-input w-full p-3 text-sm" placeholder="Google Maps åœ°é»">
             
             <div class="relative w-full h-32 bg-slate-50 border-2 border-dashed border-slate-200 rounded-xl flex flex-col items-center justify-center text-slate-400 overflow-hidden">
                 <input type="file" accept="image/*" @change="handleImageUpload" class="absolute inset-0 opacity-0 z-10">
                 <div v-if="!itinForm.imgUrl" class="text-xs font-bold flex flex-col items-center gap-1">
                     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                     é»æ“Šä¸Šå‚³åœ–ç‰‡
                 </div>
                 <img v-else :src="itinForm.imgUrl" class="w-full h-full object-cover">
                 <button v-if="itinForm.imgUrl" @click.prevent="removeImage" class="absolute top-2 right-2 z-20 bg-red-500 text-white rounded-full p-1 shadow">âœ•</button>
             </div>

             <textarea v-model="itinForm.note" rows="3" class="ios-input w-full p-3 text-sm" placeholder="å‚™è¨»..."></textarea>
             <input v-model="itinForm.link" class="ios-input w-full p-3 text-xs text-blue-500" placeholder="ç›¸é—œé€£çµ URL">
         </div>
         <div class="p-4 border-t border-slate-100 flex gap-3 bg-white">
             <button @click="submitItin" class="flex-1 btn-primary py-3 rounded-xl font-bold">å„²å­˜</button>
         </div>
      </div>

      <div v-if="showExpModal" class="modal-card bg-white w-full max-w-sm rounded-3xl shadow-2xl relative z-10 flex flex-col max-h-[85vh]">
          <div class="px-5 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
             <h3 class="font-bold text-slate-800">ç·¨è¼¯æ¶ˆè²»</h3>
             <button @click="closeAllModals" class="text-slate-400 p-1">âœ•</button>
          </div>
          <div class="p-5 overflow-y-auto space-y-4">
              <div class="flex gap-2">
                  <select v-model="editExpForm.currency" class="ios-input w-24 p-3 font-mono text-center"><option>NTD</option><option>NOK</option><option>ISK</option><option>EUR</option><option>GBP</option><option>AED</option></select>
                  <input type="number" v-model="editExpForm.amount" class="ios-input flex-1 p-3 text-lg font-bold">
              </div>
              <div class="grid grid-cols-2 gap-2">
                  <select v-model="editExpForm.item" class="ios-input p-3 text-xs"><option v-for="i in uniqueItems" :value="i">{{i}}</option></select>
                  <select v-model="editExpForm.payer" class="ios-input p-3 text-xs"><option v-for="p in members" :value="p">{{p}}</option></select>
              </div>
              <input v-model="editExpForm.note" class="ios-input w-full p-3" placeholder="å‚™è¨»">
              
              <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                <div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-slate-400">åˆ†æ”¤</span><button @click="toggleSelectAllEdit" class="text-xs text-sky-500 font-bold">å…¨é¸</button></div>
                <div class="flex flex-wrap gap-2">
                    <label v-for="m in members" :key="m" class="flex items-center gap-1 bg-white border px-2 py-1 rounded text-xs">
                        <input type="checkbox" :value="m" v-model="editExpForm.involved"> {{m}}
                    </label>
                </div>
              </div>
              
              <div class="flex gap-3 mt-4">
                  <button @click="deleteExp(editExpForm)" class="flex-1 bg-red-50 text-red-500 py-3 rounded-xl font-bold border border-red-100">åˆªé™¤</button>
                  <button @click="submitEditExp" class="flex-[2] btn-primary py-3 rounded-xl font-bold">æ›´æ–°</button>
              </div>
          </div>
      </div>

      <div v-if="showRateModal" class="modal-card bg-white w-full max-w-sm rounded-3xl shadow-2xl relative z-10 p-6">
          <h3 class="font-bold text-slate-800 mb-4 text-center">åŒ¯ç‡è¨­å®š (TWD)</h3>
          <div class="space-y-3">
              <div v-for="c in ['NOK','ISK','EUR','GBP','AED']" :key="c" class="flex items-center gap-3">
                  <span class="w-10 font-bold text-slate-400">{{c}}</span>
                  <input type="number" v-model="tempRates[c]" class="ios-input flex-1 p-2 text-right font-mono font-bold">
              </div>
          </div>
          <button @click="saveRates" class="w-full btn-primary mt-6 py-3 rounded-xl font-bold">å„²å­˜è¨­å®š</button>
      </div>

    </div>
  </Transition>

  <Transition name="fade">
    <div v-if="showImgViewer" class="img-viewer-overlay" @click="closeImgViewer"
         @touchstart="handleImgTouchStart" @touchmove="handleImgTouchMove" @touchend="handleImgTouchEnd">
        <div class="absolute top-10 right-6 z-50 p-2 bg-white/20 rounded-full backdrop-blur-md border border-white/30 text-white font-bold" @click.stop="closeImgViewer">âœ•</div>
        <img :src="viewingImg" ref="imgViewerEl" class="img-viewer-img transition-transform duration-75" @click.stop @dblclick="toggleZoom">
        <div class="absolute bottom-10 text-white/50 text-xs font-bold pointer-events-none">ä¸‹æ‹‰é—œé–‰</div>
    </div>
  </Transition>

</div>

<script>
// --- Configuration ---
const YOUR_GAS_URL = 'https://script.google.com/macros/s/AKfycbz6PZtqLJzlS2a71R-RfZjpJCuqJVPoP7RuNxEe74mS_uvxBejMNGKboFSn2ArNnXAu/exec';

// --- Service Worker Registration ---
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(()=>{}));
}

// --- API Helper ---
async function callApi(action, data = null, method = 'GET') {
  const options = { method };
  if (method === 'POST') {
    options.body = JSON.stringify({ action, data });
    options.headers = { 'Content-Type': 'text/plain;charset=utf-8' };
  }
  let url = YOUR_GAS_URL;
  if (method === 'GET') url += `?action=${action}`;
  try {
    const response = await fetch(url, options);
    if (!response.ok) throw new Error("Network error");
    return await response.json();
  } catch(e) {
    console.warn("API Fail:", e);
    return null; 
  }
}

const { createApp, ref, computed, onMounted, nextTick, watch, onBeforeUnmount } = Vue;

createApp({
  setup() {
    // --- State ---
    const tab = ref('itinerary');
    const isLoading = ref(true);
    const isFirstLoad = ref(true);
    const isOnline = ref(navigator.onLine);
    const isSyncing = ref(false);
    const syncQueue = ref([]);
    
    // Data
    const members = ref([]);
    const expenses = ref([]);
    const itinerary = ref([]);
    const rates = ref({});
    
    // UI Refs
    const dateContainer = ref(null);
    const scrollContainer = ref(null);
    const todayDate = ref('');
    const todayWeekday = ref('');

    // --- Pull to Refresh State ---
    const pullDistance = ref(0);
    const isPullRefreshing = ref(false);
    const refreshText = computed(() => isPullRefreshing.value ? 'æ›´æ–°ä¸­...' : 'ä¸‹æ‹‰æ›´æ–°');

    // --- Image Viewer State ---
    const showImgViewer = ref(false);
    const viewingImg = ref('');
    const imgViewerEl = ref(null);
    const imgGesture = ref({ startX:0, startY:0, scale:1, isPulling:false, isZooming:false, startDistance:0, currentY:0 });

    // --- Core Logic: Dates ---
    const tripDates = [];
    const startDate = new Date('2026-08-30');
    const endDate = new Date('2026-09-26');
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate()+1)) {
      tripDates.push({ date: d.toISOString().split('T')[0], short: (d.getMonth()+1)+'/'+d.getDate() });
    }
    const selDate = ref(tripDates[0].date);

    // --- Core Logic: Forms & Modals ---
    const showItinModal = ref(false);
    const showExpModal = ref(false);
    const showRateModal = ref(false);
    const showFilterMenu = ref(false);
    const isEditing = ref(false);
    
    const itinForm = ref({ row: null, startTime: '09:00', endTime: '', category: 'æ™¯é»', title: '', location: '', link: '', note: '', imgUrl: '' });
    const newExp = ref({ payer: '', location: '', item: '', payment: '', currency: 'NTD', amount: null, involved: [], note: '' });
    const editExpForm = ref({});
    const tempRates = ref({});
    const filters = ref({ item:'ALL', payer:'ALL' });

    // --- Computed Helpers ---
    const tripStatus = computed(() => {
      const now = new Date(); now.setHours(0,0,0,0);
      const start = new Date(startDate); start.setHours(0,0,0,0);
      if (now < start) return `å€’æ•¸ ${Math.ceil((start - now)/86400000)} å¤©`;
      if (now >= start && now <= endDate) return `DAY ${Math.floor((now - start)/86400000) + 1}`;
      return 'æ—…ç¨‹çµæŸ';
    });

    const getDayInfo = (dStr) => {
        const d = new Date(dStr);
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        return `DAY ${Math.ceil((d - startDate)/86400000) + 1} Â· ${days[d.getDay()]}`;
    };

    const getEvents = (d) => itinerary.value.filter(e => e.date === d).sort((a,b)=>a.startTime.localeCompare(b.startTime));
    const isItemPending = (row) => syncQueue.value.some(j => j.data.row === row);
    
    // Icons for expenses
    const getIcon = (item) => {
        const i = item || '';
        if(i.includes('é£›æ©Ÿ')||i.includes('ç¥¨')) return 'âœˆï¸';
        if(i.includes('é¤')||i.includes('é£Ÿ')||i.includes('é…’')) return 'ğŸ”';
        if(i.includes('ä½')||i.includes('å®¿')) return 'ğŸ¨';
        if(i.includes('è»Š')||i.includes('æ²¹')) return 'ğŸš—';
        return 'ğŸ’¸';
    };
    const getItemTagClass = (item) => {
        const i = item || '';
        if(i.includes('é¤')||i.includes('é£Ÿ')) return 'food';
        if(i.includes('è»Š')||i.includes('æ²¹')||i.includes('ç¥¨')) return 'traffic';
        if(i.includes('ä½')) return 'stay';
        return 'other';
    };

    // --- Methods: Navigation ---
    const changeTab = (t) => { 
        tab.value = t; 
        if(scrollContainer.value) scrollContainer.value.scrollTop = 0;
    };
    const changeTabToAnalysis = () => { changeTab('analysis'); scheduleRenderChart(); };
    const selectDate = (date) => {
        selDate.value = date;
        nextTick(() => {
            const btn = document.getElementById('date-btn-' + date);
            if(btn) btn.scrollIntoView({behavior: 'smooth', block: 'nearest', inline: 'center'});
        });
        if(scrollContainer.value) scrollContainer.value.scrollTop = 0;
    };

    // --- Methods: Data Load & Sync ---
    const saveLocal = () => {
        localStorage.setItem('tripData_v40', JSON.stringify({expenses:expenses.value, itinerary:itinerary.value, members:members.value, rates:rates.value}));
        localStorage.setItem('syncQueue_v40', JSON.stringify(syncQueue.value));
    };
    const loadLocal = () => {
        const d = localStorage.getItem('tripData_v40');
        if(d) {
            const p = JSON.parse(d);
            expenses.value=p.expenses||[]; itinerary.value=p.itinerary||[]; members.value=p.members||[]; rates.value=p.rates||{};
            return true;
        }
        return false;
    };
    const loadData = async () => {
        if(!isPullRefreshing.value) isLoading.value = true;
        loadLocal();
        if(isFirstLoad.value) {
            const today = new Date().toISOString().split('T')[0];
            if(tripDates.some(x=>x.date===today)) selectDate(today);
            isFirstLoad.value=false;
        }
        if(navigator.onLine) {
            const res = await callApi('getData');
            if(res && res.expenses) {
                expenses.value = res.expenses; itinerary.value = res.itinerary; members.value = res.members; rates.value = res.rates;
                saveLocal();
            }
        }
        isLoading.value = false; isPullRefreshing.value = false; pullDistance.value = 0;
        if(tab.value==='analysis') scheduleRenderChart();
    };

    // --- Methods: CRUD ---
    const handleCRUD = async (type, action, data) => {
        // Optimistic UI updates happen in submit functions
        const job = { type, action, data };
        if(navigator.onLine) {
            isSyncing.value = true;
            try {
                const apiAction = action + (type==='itin'?'Itinerary':'Expense');
                if(action==='delete') apiAction = 'deleteRow'; // Special case based on GAS
                await callApi(type==='itin' && action==='delete' ? 'deleteRow' : apiAction, data, 'POST'); // Simplified logic
                // In a real app, you'd handle the 'delete' route mapping better
            } catch(e) { syncQueue.value.push(job); }
            finally { isSyncing.value = false; }
        } else {
            syncQueue.value.push(job);
        }
        saveLocal();
    };
    
    // Wrapper for simplified GAS calls (matching original logic roughly)
    const backendCall = async (type, action, payload) => {
        let apiAct = '';
        if(action === 'delete') apiAct = 'deleteRow';
        else apiAct = action + (type==='itin'?'Itinerary':'Expense');
        
        if(navigator.onLine) {
            isSyncing.value = true;
            try { await callApi(apiAct, payload, 'POST'); } 
            catch(e) { syncQueue.value.push({type, action, data:payload}); }
            finally { isSyncing.value = false; }
        } else {
             syncQueue.value.push({type, action, data:payload});
        }
        saveLocal();
    };

    const submitItin = () => {
        if(!itinForm.value.title) return;
        const p = { ...itinForm.value, row: isEditing.value ? itinForm.value.row : Date.now(), date: selDate.value };
        if(isEditing.value) {
            const idx = itinerary.value.findIndex(x=>x.row===p.row);
            if(idx!==-1) itinerary.value[idx] = p;
            backendCall('itin','edit',p);
        } else {
            itinerary.value.push(p);
            backendCall('itin','add',p);
        }
        closeAllModals();
    };
    const deleteItin = (evt) => {
        if(!confirm('åˆªé™¤?')) return;
        itinerary.value = itinerary.value.filter(x=>x.row!==evt.row);
        backendCall('itin','delete',{row:evt.row, sheetName:'Itinerary'});
    };
    const submitExp = () => {
        if(!newExp.value.amount) return;
        const p = { ...newExp.value, row: Date.now(), date: new Date().toISOString().split('T')[0], time: new Date().toTimeString().slice(0,5), amountTWD: Math.round(newExp.value.amount * (rates.value[newExp.value.currency] || 1)) };
        expenses.value.unshift(p);
        backendCall('exp','add',p);
        newExp.value = { payer: '', location: '', item: '', payment: '', currency: 'NTD', amount: null, involved: [], note: '' };
        alert('å·²è¨˜å¸³');
    };
    const deleteExp = (exp) => {
        if(!confirm('åˆªé™¤?')) return;
        expenses.value = expenses.value.filter(x=>x.row!==exp.row);
        backendCall('exp','delete',{row:exp.row, sheetName:'Expenses'});
        closeAllModals();
    };
    const submitEditExp = () => {
        const idx = expenses.value.findIndex(e=>e.row===editExpForm.value.row);
        if(idx!==-1) {
            const up = {...editExpForm.value, amountTWD: Math.round(editExpForm.value.amount * (rates.value[editExpForm.value.currency] || 1))};
            expenses.value[idx] = up;
            backendCall('exp','edit',up);
        }
        closeAllModals();
    };

    // --- Methods: Analysis ---
    const formatNumber = (n) => String(n).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    const getAmountTWD = (e) => e.amountTWD || Math.round(e.amount*(rates.value[e.currency]||1));
    
    const uniqueItems = computed(()=>[...new Set(expenses.value.map(e=>e.item))].filter(Boolean));
    const filteredExpenses = computed(() => expenses.value.filter(e => 
        (filters.value.item==='ALL' || e.item===filters.value.item) &&
        (filters.value.payer==='ALL' || e.payer===filters.value.payer)
    ));
    
    const publicSpent = computed(() => expenses.value.reduce((sum,e)=>{
        if(!e.involved?.length) return sum;
        const share = getAmountTWD(e)/e.involved.length;
        let c=0; if(e.involved.includes('å®¶é½Š')) c+=share; if(e.involved.includes('äº­ç©')) c+=share;
        return sum+c;
    },0));

    const debts = computed(() => {
        const bal = {}; members.value.forEach(m=>bal[m]=0);
        expenses.value.forEach(e=>{
            const amt = getAmountTWD(e);
            if(e.involved?.length) {
                bal[e.payer] += amt;
                const share = amt/e.involved.length;
                e.involved.forEach(p=>{ if(bal[p]!==undefined) bal[p]-=share; });
            }
        });
        let d=[], c=[];
        for(const m in bal) { if(bal[m]<-1) d.push({p:m,a:bal[m]}); if(bal[m]>1) c.push({p:m,a:bal[m]}); }
        d.sort((a,b)=>a.a-b.a); c.sort((a,b)=>b.a-a.a);
        const r=[]; let i=0,j=0;
        while(i<d.length && j<c.length){
            const amt = Math.min(Math.abs(d[i].a), c[j].a);
            r.push({from:d[i].p, to:c[j].p, amount:Math.round(amt)});
            d[i].a+=amt; c[j].a-=amt;
            if(Math.abs(d[i].a)<1) i++; if(c[j].a<1) j++;
        }
        return r;
    });

    let chartInstance=null;
    const chartBusy=ref(false);
    const scheduleRenderChart = async () => {
        chartBusy.value=true;
        await nextTick();
        const ctx = document.getElementById('expenseChart');
        if(!ctx) return;
        
        const stats={}; filteredExpenses.value.forEach(e=>{ const k=e.item||'å…¶ä»–'; stats[k]=(stats[k]||0)+getAmountTWD(e); });
        const labels=Object.keys(stats); const data=Object.values(stats);
        const colors = ['#38bdf8', '#fb7185', '#fbbf24', '#34d399', '#a78bfa', '#94a3b8'];
        
        if(chartInstance) {
            chartInstance.data.labels=labels; chartInstance.data.datasets[0].data=data; 
            chartInstance.data.datasets[0].backgroundColor=labels.map((_,i)=>colors[i%colors.length]);
            chartInstance.update();
        } else {
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: { labels, datasets:[{ data, backgroundColor:labels.map((_,i)=>colors[i%colors.length]), borderWidth:0 }] },
                options: { responsive:true, maintainAspectRatio:false, cutout:'65%', plugins:{ legend:{position:'right', labels:{usePointStyle:true, boxWidth:8, font:{size:10}}} } }
            });
        }
        chartBusy.value=false;
    };

    // --- Methods: UI Util ---
    const toggleSelectAll = () => newExp.value.involved = (newExp.value.involved.length===members.value.length) ? [] : [...members.value];
    const toggleMember = (m) => { const idx=newExp.value.involved.indexOf(m); if(idx>-1) newExp.value.involved.splice(idx,1); else newExp.value.involved.push(m); };
    const toggleSelectAllEdit = () => { const all=[...members.value]; editExpForm.value.involved = (editExpForm.value.involved?.length===all.length) ? [] : all; };
    const openAddItin = () => { itinForm.value={row:null,startTime:'09:00',category:'æ™¯é»',title:'',location:'',note:'',imgUrl:''}; isEditing.value=false; showItinModal.value=true; };
    const openEditItin = (e) => { itinForm.value={...e}; isEditing.value=true; showItinModal.value=true; };
    const openEditExp = (e) => { editExpForm.value=JSON.parse(JSON.stringify(e)); showExpModal.value=true; };
    const openRateModal = () => { tempRates.value={...rates.value}; showRateModal.value=true; };
    const closeAllModals = () => { showItinModal.value=false; showExpModal.value=false; showRateModal.value=false; };
    const confirmClearSync = () => { if(confirm('æ¸…ç©ºæœªä¸Šå‚³ä½‡åˆ—?')) { syncQueue.value=[]; saveLocal(); } };
    
    // Image Handling
    const handleImageUpload = (e) => {
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => { itinForm.value.imgUrl = evt.target.result; };
        reader.readAsDataURL(file);
    };
    const removeImage = () => { itinForm.value.imgUrl = ''; };
    const viewImage = (url) => { viewingImg.value = url; showImgViewer.value = true; };
    const closeImgViewer = () => { showImgViewer.value = false; };
    
    // Image Gestures (Simplified for Vue)
    const handleImgTouchStart = (e) => {
        if(e.touches.length===1) {
            imgGesture.value.startY = e.touches[0].clientY;
            imgGesture.value.isPulling = false;
        }
    };
    const handleImgTouchMove = (e) => {
        if(e.touches.length===1 && imgGesture.value.scale===1) {
            const dy = e.touches[0].clientY - imgGesture.value.startY;
            if(dy>0) {
                e.preventDefault();
                imgGesture.value.isPulling = true;
                if(imgViewerEl.value) imgViewerEl.value.style.transform = `translateY(${dy}px)`;
                imgGesture.value.currentY = dy;
            }
        }
    };
    const handleImgTouchEnd = () => {
        if(imgGesture.value.isPulling) {
            if(imgGesture.value.currentY > 100) closeImgViewer();
            else if(imgViewerEl.value) imgViewerEl.value.style.transform = '';
        }
        imgGesture.value.isPulling=false; imgGesture.value.currentY=0;
    };
    const toggleZoom = () => {
        if(imgGesture.value.scale===1) { imgGesture.value.scale=2.5; if(imgViewerEl.value) imgViewerEl.value.style.transform='scale(2.5)'; }
        else { imgGesture.value.scale=1; if(imgViewerEl.value) imgViewerEl.value.style.transform=''; }
    };

    // --- Gesture Logic for Pull-to-Refresh & Swipe Tabs ---
    const attachGestures = () => {
        const el = scrollContainer.value; if(!el) return;
        let startX=0, startY=0, isPull=false;

        el.addEventListener('touchstart', (e) => {
            const t = e.touches[0]; startX=t.clientX; startY=t.clientY;
            if(el.scrollTop <= 0) isPull=true; else isPull=false;
        }, {passive:true});
        
        el.addEventListener('touchmove', (e) => {
            const t = e.touches[0]; const dy = t.clientY - startY; const dx = t.clientX - startX;
            // Pull Refresh
            if(isPull && dy > 0 && Math.abs(dx) < dy && !isPullRefreshing.value) {
                if(e.cancelable) e.preventDefault();
                pullDistance.value = Math.min(80, Math.pow(dy, 0.8));
            }
        }, {passive:false});
        
        el.addEventListener('touchend', (e) => {
            if(pullDistance.value > 60) {
                isPullRefreshing.value = true;
                pullDistance.value = 50; // keep showing spinner
                loadData();
            } else {
                pullDistance.value = 0;
            }
            // Swipe Tabs (Simplified)
            const dx = e.changedTouches[0].clientX - startX;
            if(Math.abs(dx) > 100 && Math.abs(e.changedTouches[0].clientY - startY) < 50) {
                if(dx > 0 && tab.value==='expense') changeTab('itinerary');
                if(dx > 0 && tab.value==='analysis') changeTab('expense');
                if(dx < 0 && tab.value==='itinerary') changeTab('expense');
                if(dx < 0 && tab.value==='expense') changeTabToAnalysis();
            }
        });
    };

    onMounted(async () => {
        const now = new Date();
        todayDate.value = now.toISOString().split('T')[0];
        todayWeekday.value = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][now.getDay()];
        
        window.addEventListener('online', ()=>isOnline.value=true);
        window.addEventListener('offline', ()=>isOnline.value=false);
        
        await nextTick();
        attachGestures();
        loadData();
    });

    return {
        tab, isLoading, isOnline, isSyncing, syncQueue, tripStatus, todayDate, todayWeekday,
        tripDates, selDate, itinerary, expenses, members, rates,
        // Methods
        selectDate, getDayInfo, getEvents, isItemPending,
        getIcon, getItemTagClass,
        changeTab, changeTabToAnalysis,
        // Forms
        showItinModal, showExpModal, showRateModal, isEditing,
        itinForm, newExp, editExpForm, tempRates,
        openAddItin, openEditItin, openEditExp, openRateModal, closeAllModals,
        submitItin, deleteItin, submitExp, deleteExp, submitEditExp, saveRates,
        handleImageUpload, removeImage, viewImage, closeImgViewer, showImgViewer, viewingImg, imgViewerEl, handleImgTouchStart, handleImgTouchMove, handleImgTouchEnd, toggleZoom,
        confirmClearSync, toggleSelectAll, toggleSelectAllEdit, toggleMember,
        // Stats
        formatNumber, getAmountTWD, publicSpent, debts, 
        filteredExpenses, uniqueItems, showFilterMenu, filters, resetFilters:()=>{filters.value={item:'ALL',payer:'ALL'}},
        chartBusy,
        // Refs
        dateContainer, scrollContainer, pullDistance, isPullRefreshing, refreshText
    };
  }
}).mount('#app');
</script>
</body>
</html>
