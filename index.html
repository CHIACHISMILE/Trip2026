<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>2026æŒªå¨å†°å³¶ä¹‹æ—…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="2026æŒªå¨å†°å³¶ä¹‹æ—…">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#dbeafe">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="https://img.icons8.com/color/180/snowflake.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* =========================================================
       GLOBAL
    ========================================================= */
    html, body {
      height: 100dvh;
      width: 100%;
      overflow: hidden;
      font-family: 'Inter', 'Noto Sans TC', -apple-system, sans-serif;
      background-color: #f0f9ff;
      color: #1e3a8a;
      overscroll-behavior: none;

      /* é è¨­é¿å…æ•´é èª¤é¸å­—ï¼ˆä½†å…è¨± .allow-select overrideï¼‰ */
      user-select: none;
      -webkit-user-select: none;

      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    /* iOSï¼šé¿å…é•·æŒ‰æ•´é å‡ºç¾ calloutï¼ˆä½† .allow-select æœƒé–‹å›ä¾†ï¼‰ */
    body {
      -webkit-touch-callout: none;
    }

    #fixed-bg {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(160deg, #dbeafe 0%, #eff6ff 40%, #f0f9ff 100%);
      z-index: -1;
      pointer-events: none;
    }

    #app {
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    .scrollable-content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-y: contain;

      position: relative;
      padding-top: 10px;
      padding-bottom: calc(90px + env(safe-area-inset-bottom));

      /* è®“ç€è¦½å™¨çŸ¥é“ä¸»è¦æ˜¯å‚ç›´æ»¾å‹•ï¼ˆæˆ‘å€‘ç”¨ JS åšæ°´å¹³ swipeï¼‰ */
      touch-action: pan-y;
    }

    /* =========================================================
       UI
    ========================================================= */
    .glass-card {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.8);
      border-radius: 20px;
      box-shadow: 0 4px 15px rgba(148, 163, 184, 0.08);
      transition: transform 0.15s ease-out;
    }
    .glass-card:active { transform: scale(0.99); }

    .glass-input {
      background: rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.6);
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.01);
      color: #334155;
      transition: all 0.3s;
    }
    .glass-input:focus {
      background: #fff;
      border-color: #38bdf8;
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.15);
    }

    .btn-glacier {
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 4px 12px rgba(14, 165, 233, 0.25);
    }
    .btn-glacier:active {
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
      transform: translateY(1px);
    }

    .tab-bar {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 4px 20px -5px rgba(0, 0, 0, 0.05);
    }
    .tab-btn { color: #94a3b8; transition: all 0.3s; }
    .tab-active { color: #0284c7; position: relative; }
    .tab-active::after {
      content: '';
      position: absolute;
      bottom: 0; left: 35%;
      width: 30%; height: 4px;
      background: #0284c7;
      border-radius: 4px 4px 0 0;
      box-shadow: 0 -2px 8px rgba(2, 132, 199, 0.5);
    }

    .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }

    .pull-indicator {
      height: 0;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      padding-bottom: 5px;
      overflow: hidden;
      color: #64748b;
      font-weight: 600;
      font-size: 0.8rem;
      transition: height 0.12s ease-out;
      padding-top: env(safe-area-inset-top);
      box-sizing: content-box;
    }

    .scrollbar-hide::-webkit-scrollbar { display: none; }

    .title-link {
      text-decoration: none;
      color: #0f172a;
      font-weight: 700;
      border-bottom: 1px dashed #cbd5e1;
    }
    .map-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 8px;
      background: white;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
      font-size: 10px;
      font-weight: bold;
      color: #0284c7;
      text-decoration: none;
      flex-shrink: 0;
    }

    .cat-traffic { border-left: 4px solid #3b82f6; background: white; }
    .cat-stay    { border-left: 4px solid #eab308; background: white; }
    .cat-spot    { border-left: 4px solid #a855f7; background: white; }
    .cat-food    { border-left: 4px solid #f97316; background: white; }
    .cat-note    { border-left: 4px solid #64748b; background: white; }

    .skeleton {
      background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 8px;
    }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    .pending-sync { opacity: 0.7; border: 1px dashed #f59e0b; }
    .pending-badge { background: #f59e0b; color: white; padding: 1px 5px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-left: 5px; }

    /* =========================================================
       TEXT SELECTION (iOS KEY)
    ========================================================= */
    .allow-select {
      user-select: text !important;
      -webkit-user-select: text !important;

      /* iOS é•·æŒ‰è¤‡è£½é¸å–® */
      -webkit-touch-callout: default !important;

      cursor: text;
    }

    /* iOSï¼šè®“åç™½æ›´ç©©ï¼ˆå¯æœ‰å¯ç„¡ï¼‰ */
    .allow-select::selection { background: rgba(56, 189, 248, 0.25); }

    .line-clamp-6 {
      display: -webkit-box;
      -webkit-line-clamp: 6;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .break-anywhere {
      overflow-wrap: anywhere;
      word-break: break-all;
    }
  </style>
</head>

<body>
<div id="fixed-bg"></div>

<div id="app">
  <div class="pull-indicator" :style="{ height: pullDistance + 'px' }">
    <span v-if="pullDistance > 20">{{ refreshText }}</span>
  </div>

  <!-- Header (ä¸å…è¨± swipe ä»‹å…¥) -->
  <div class="px-6 pb-4 rounded-b-[2.5rem] shadow-sm swipe-protected relative z-20"
       style="background: rgba(255,255,255,0.6); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border-bottom: 1px solid rgba(255,255,255,0.4);
       padding-top: max(20px, env(safe-area-inset-top) + 12px);">

    <div class="flex justify-between items-center">
      <h1 class="text-xl font-black tracking-tighter text-slate-800 drop-shadow-sm">2026 æŒªå¨å†°å³¶ä¹‹æ—…</h1>
      <div class="text-right">
        <button v-if="syncQueue.length > 0" @click="forceClearSync"
                class="bg-amber-500 text-white px-3 py-1.5 rounded-full text-xs font-bold shadow-lg animate-pulse flex items-center gap-1 mb-1 ml-auto">
          å¾…ä¸Šå‚³ ({{ syncQueue.length }})
        </button>
        <div class="text-lg font-black text-sky-900 leading-none tracking-wide font-mono">{{ todayDate }}</div>
        <div class="text-[10px] text-sky-600 font-bold opacity-80 mt-1 uppercase tracking-[0.2em]">{{ todayWeekday }}</div>
      </div>
    </div>

    <div class="flex justify-between items-center mt-4">
      <div class="glass-input px-3 py-1.5 rounded-full text-[10px] font-bold text-slate-500 tracking-wide">AUG 30 - SEP 26</div>
      <div class="flex gap-2">
        <span v-if="!isOnline" class="bg-slate-500 text-white px-3 py-1 rounded-full text-xs font-bold shadow-md flex items-center gap-1">é›¢ç·š</span>
        <span v-if="tripStatus" class="bg-gradient-to-r from-sky-400 to-blue-500 text-white px-3 py-1 rounded-full text-xs font-bold shadow-md">{{ tripStatus }}</span>
      </div>
    </div>
  </div>

  <!-- Tabs (ä¸å…è¨± swipe ä»‹å…¥) -->
  <div class="flex tab-bar z-10 text-sm font-bold swipe-protected flex-shrink-0">
    <button @click="tab='itinerary'" :class="['flex-1 p-4 tab-btn', tab==='itinerary'?'tab-active':'']">è¡Œç¨‹</button>
    <button @click="tab='expense'"   :class="['flex-1 p-4 tab-btn', tab==='expense'?'tab-active':'']">è¨˜å¸³</button>
    <button @click="changeTabToAnalysis" :class="['flex-1 p-4 tab-btn', tab==='analysis'?'tab-active':'']">åˆ†æ</button>
  </div>

  <!-- Main Scroll -->
  <div class="scrollable-content p-4" ref="scrollContainer">
    <Transition name="fade" mode="out-in">
      <!-- Itinerary -->
      <div v-if="tab==='itinerary'" key="itinerary">
        <!-- Date bar (ä¸å…è¨± swipe ä»‹å…¥) -->
        <div ref="dateContainer" class="overflow-x-auto whitespace-nowrap pb-4 px-1 scrollbar-hide scroll-smooth swipe-protected">
          <button v-for="d in tripDates" :key="d.date" :id="'date-btn-' + d.date" @click="selectDate(d.date)"
                  :class="[
                    'px-4 py-2.5 rounded-2xl text-xs mr-2 border transition-all duration-300 font-bold shadow-sm',
                    selDate===d.date ? 'bg-sky-600 text-white border-sky-600 shadow-sky-200 shadow-lg scale-105'
                                     : 'glass-input text-slate-400 border-transparent hover:bg-white'
                  ]">
            {{ d.short }}
          </button>
        </div>

        <div v-if="isLoading && itinerary.length===0" class="space-y-4">
          <div v-for="i in 3" :key="i" class="glass-card h-24 skeleton"></div>
        </div>

        <div v-else>
          <div class="text-center mb-6">
            <div class="inline-block glass-input px-6 py-2 rounded-full text-sm font-bold text-slate-600 shadow-sm">
              {{ getDayInfo(selDate) }}
            </div>
          </div>

          <div v-for="evt in getEvents(selDate)" :key="evt.row"
               :class="['glass-card flex mb-4 items-stretch overflow-hidden group', evt.isPending ? 'pending-sync' : '', getCategoryClass(evt.category)]">
            <div class="w-16 flex flex-col justify-center items-center p-2 bg-slate-50/50 border-r border-slate-100 flex-shrink-0 swipe-protected">
              <div class="font-black text-sm text-slate-700">{{ evt.startTime }}</div>
              <div v-if="evt.endTime" class="text-[10px] text-slate-400 mt-1 font-medium">{{ evt.endTime }}</div>
              <div class="mt-2 text-[10px] font-bold px-1.5 py-0.5 rounded text-slate-500 bg-white border border-slate-200 tracking-wider">
                {{ evt.category }}
              </div>
            </div>

            <div class="flex-1 p-4 relative min-w-0" @click="toggleExpand(evt.row)">
              <div class="flex justify-between items-start">
                <span v-if="!evt.link" class="font-bold text-base text-slate-800 leading-tight truncate pr-2">
                  {{ evt.title }}
                </span>
                <a v-else :href="evt.link" target="_blank" class="title-link text-base leading-tight truncate pr-2 swipe-protected">
                  {{ evt.title }}
                </a>
              </div>

              <div class="text-xs mt-2 text-slate-500 flex items-start gap-2" v-if="evt.location">
                <span class="flex-1 pt-1 opacity-80 break-words">ğŸ“ {{ evt.location }}</span>
                <a :href="'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(evt.location)"
                   target="_blank"
                   class="map-btn swipe-protected">åœ°åœ–</a>
              </div>

              <!-- âœ… é—œéµï¼šå¯é¸å–æ–‡å­—å€ï¼Œäº‹ä»¶ stop + iOS callout -->
              <div
                class="text-sm mt-3 text-slate-600 whitespace-pre-wrap opacity-90 allow-select break-anywhere"
                :class="{'line-clamp-6': expandedId !== evt.row}"
                v-if="evt.note"
                @click.stop
                @touchstart.stop
                @touchmove.stop
                @touchend.stop
              >{{ evt.note }}</div>

              <div class="mt-3 flex gap-2 justify-end swipe-protected">
                <button @click.stop="openEditItin(evt)"
                        class="text-[10px] text-sky-600 bg-sky-50 border border-sky-100 px-3 py-1 rounded-lg font-bold flex-shrink-0">
                  ç·¨è¼¯
                </button>
                <button @click.stop="deleteItin(evt)"
                        class="text-[10px] text-red-500 bg-red-50 border border-red-100 px-3 py-1 rounded-lg font-bold flex-shrink-0">
                  åˆªé™¤
                </button>
              </div>
            </div>
          </div>

          <button @click="openAddItin"
                  class="w-full py-4 mt-4 border-2 border-dashed border-sky-200 text-sky-400 rounded-2xl font-bold hover:bg-sky-50 transition swipe-protected">
            + æ–°å¢è¡Œç¨‹
          </button>
          <div class="h-10"></div>
        </div>
      </div>

      <!-- Expense -->
      <div v-else-if="tab==='expense'" key="expense">
        <div class="glass-card p-6 space-y-5 shadow-lg swipe-protected">
          <h3 class="font-bold text-slate-800 text-lg flex items-center gap-2">
            <span class="w-1 h-6 bg-sky-500 rounded-full"></span>æ–°å¢æ¶ˆè²»
          </h3>

          <div class="flex gap-3">
            <select v-model="newExp.payer" class="w-1/2 glass-input p-3 rounded-xl text-sm outline-none font-bold">
              <option value="" disabled selected>æ³¥æ˜¯èª°</option>
              <option>å®¶é½Š</option><option>äº­ç©</option><option>åª½åª½</option>
            </select>
            <select v-model="newExp.location" class="w-1/2 glass-input p-3 rounded-xl text-sm outline-none font-bold">
              <option value="" disabled selected>åœ¨å“ªæ¶ˆè²»</option>
              <option>å°ç£</option><option>æœæ‹œ</option><option>æŒªå¨</option><option>å†°å³¶</option><option>è‹±åœ‹</option>
            </select>
          </div>

          <div class="flex gap-3">
            <select v-model="newExp.item" class="w-1/2 glass-input p-3 rounded-xl text-sm outline-none font-bold">
              <option value="" disabled selected>æ¶ˆè²»é …ç›®</option>
              <option>æ—©é¤</option><option>åˆé¤</option><option>æ™šé¤</option><option>é›¶é£Ÿ</option><option>ä½å®¿</option>
              <option>äº¤é€šï¼ˆæ©Ÿç¥¨ï¼‰</option><option>äº¤é€šï¼ˆç§Ÿè»Šï¼‰</option><option>äº¤é€šï¼ˆåœè»Šè²»ï¼‰</option><option>äº¤é€šï¼ˆæ²¹éŒ¢ï¼‰</option>
              <option>ç´€å¿µå“</option><option>é–€ç¥¨</option><option>å…¶ä»–</option>
            </select>
            <select v-model="newExp.payment" class="w-1/2 glass-input p-3 rounded-xl text-sm outline-none font-bold">
              <option value="" disabled selected>ä»˜æ¬¾æ–¹å¼</option>
              <option>ç¾é‡‘</option><option>ä¿¡ç”¨å¡-åœ‹æ³°</option><option>ä¿¡ç”¨å¡-æ°¸è±</option><option>ä¿¡ç”¨å¡-å…ƒå¤§</option>
            </select>
          </div>

          <div class="flex gap-3">
            <select v-model="newExp.currency" class="w-1/3 glass-input p-3 rounded-xl text-sm outline-none font-bold text-sky-700 bg-sky-50/50">
              <option>NTD</option><option>NOK</option><option>ISK</option><option>EUR</option><option>GBP</option><option>AED</option>
            </select>
            <input type="number" v-model="newExp.amount" placeholder="é‡‘é¡"
                   class="w-2/3 glass-input p-3 rounded-xl outline-none text-xl font-mono font-bold text-slate-800">
          </div>

          <div class="text-xs text-right text-slate-400 font-mono font-bold" v-if="newExp.amount && newExp.currency !== 'NTD'">
            â‰ˆ {{ formatNumber(Math.round(newExp.amount * rates[newExp.currency])) }} NTD
          </div>

          <input v-model="newExp.note" placeholder="å‚™è¨» (é¸å¡«)" class="w-full glass-input p-3 rounded-xl text-sm outline-none">

          <div class="bg-slate-50/50 p-4 rounded-xl border border-slate-100">
            <div class="flex justify-between items-center mb-3">
              <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">åˆ†æ”¤çµ¦</span>
              <button @click="toggleSelectAll" class="text-[10px] text-sky-600 font-bold bg-white px-2 py-1 rounded shadow-sm">å…¨é¸</button>
            </div>
            <div class="flex gap-2 flex-wrap">
              <label v-for="m in members" :key="m"
                     class="flex flex-1 justify-center items-center space-x-2 border px-4 py-3 rounded-xl cursor-pointer transition-all duration-200"
                     :class="newExp.involved.includes(m)?'bg-white border-sky-400 text-sky-700 shadow-md transform -translate-y-0.5':'bg-transparent border-slate-200 text-slate-400'">
                <input type="checkbox" :value="m" v-model="newExp.involved" class="hidden">
                <span class="text-sm font-bold">{{m}}</span>
              </label>
            </div>
          </div>

          <button @click="submitExp" class="w-full btn-glacier py-4 rounded-xl font-bold text-lg tracking-wide">ç¢ºèªè¨˜å¸³</button>
        </div>
      </div>

      <!-- Analysis -->
      <div v-else-if="tab==='analysis'" key="analysis">
        <div class="flex justify-end mb-3 swipe-protected">
          <button @click="openRateModal"
                  class="text-xs text-slate-500 bg-white/50 border border-white px-4 py-2 rounded-full flex items-center shadow-sm backdrop-blur-sm font-bold">
            åŒ¯ç‡è¨­å®š
          </button>
        </div>

        <div class="bg-gradient-to-br from-[#3b82f6] to-[#6366f1] text-white rounded-3xl p-6 shadow-xl mb-6 relative overflow-hidden ring-1 ring-white/20">
          <div class="absolute -top-10 -right-10 w-48 h-48 bg-white opacity-10 rounded-full blur-3xl"></div>

          <div class="border-b border-white/10 pb-3 mb-3 flex justify-between items-center relative z-10">
            <div class="text-xs font-medium opacity-80 tracking-widest uppercase">å®¶é½Š+äº­ç© é ç®—</div>
            <div class="font-bold text-lg font-mono tracking-wider opacity-90">500,000</div>
          </div>

          <div class="flex justify-between items-end relative z-10">
            <div>
              <div class="text-4xl font-black tracking-tighter drop-shadow-sm">{{ formatNumber(Math.round(500000 - publicSpent)) }}</div>
              <div class="text-xs font-bold opacity-70 mt-1">å‰©é¤˜ç¶“è²» (NTD)</div>
            </div>
            <div class="text-right">
              <div class="text-lg font-bold">{{ formatNumber(Math.round(publicSpent)) }}</div>
              <div class="text-xs opacity-70 font-medium">å·²æ”¯å‡º ({{ Math.round(publicSpent/500000*100) }}%)</div>
            </div>
          </div>

          <div class="w-full bg-black/20 h-2 rounded-full mt-5 overflow-hidden relative z-10">
            <div class="bg-white h-full shadow-[0_0_10px_rgba(255,255,255,0.5)] transition-all duration-1000"
                 :style="{width: Math.min((publicSpent/500000)*100, 100) + '%'}"></div>
          </div>

          <div class="mt-4 pt-3 border-t border-white/20 flex justify-between items-center text-yellow-100 relative z-10">
            <span class="text-xs font-bold">åª½åª½å€‹äººèˆ‡åˆ†æ”¤æ”¯å‡º</span>
            <span class="font-bold font-mono text-lg">+ {{ formatNumber(Math.round(momSpent)) }}</span>
          </div>
        </div>

        <div class="flex justify-between items-center mb-4 swipe-protected">
          <h3 class="font-bold text-slate-700 text-lg">æ¶ˆè²»æ˜ç´°</h3>
          <select v-model="filterDate" class="glass-input px-3 py-1.5 rounded-lg text-xs text-slate-600 outline-none font-bold">
            <option value="ALL">å…¨éƒ¨æ—¥æœŸ</option>
            <option v-for="d in uniqueExpDates" :key="d" :value="d">{{ d }}</option>
          </select>
        </div>

        <div class="glass-card p-4 mb-6">
          <div class="relative h-64 w-full">
            <canvas id="expenseChart"></canvas>
          </div>
        </div>

        <div class="space-y-3 mb-8">
          <div v-for="exp in filteredExpenses" :key="exp.row"
               :class="['glass-card p-4 flex justify-between items-center transition hover:shadow-md border-l-4 border-l-sky-400', exp.isPending ? 'pending-sync' : '']">
            <div class="flex justify-between items-center w-full">
              <div>
                <div class="font-bold text-slate-800 text-base">
                  {{ exp.item }}
                  <span v-if="exp.isPending" class="pending-badge">å¾…å‚³</span>
                </div>
                <div class="text-[10px] text-slate-400 mt-1 font-mono font-medium tracking-wide uppercase">{{ exp.date }} Â· {{ exp.time }}</div>
                <div class="text-xs text-slate-500 mt-2 flex items-center flex-wrap gap-2">
                  <span class="bg-slate-100 px-2 py-0.5 rounded text-slate-600 font-bold">{{ exp.payer }}</span>
                  <span class="text-sky-600 font-bold bg-sky-50 px-2 py-0.5 rounded">{{ exp.payment }}</span>
                  <span class="text-slate-400 font-medium">{{ exp.location }}</span>
                </div>
                <div v-if="exp.note" class="text-xs text-slate-500 mt-2 italic pl-2 border-l-2 border-yellow-200 allow-select"
                     @click.stop @touchstart.stop @touchmove.stop @touchend.stop>
                  {{ exp.note }}
                </div>
              </div>

              <div class="text-right min-w-[90px] swipe-protected">
                <div class="font-bold text-slate-800 text-lg tracking-tight">
                  {{ exp.amount }} <span class="text-[10px] text-slate-400 font-bold">{{ exp.currency }}</span>
                </div>
                <div v-if="exp.currency !== 'NTD'" class="text-[10px] text-slate-400 font-mono font-bold mt-1">â‰ˆ {{ formatNumber(getAmountTWD(exp)) }}</div>
                <div class="mt-3 flex gap-2 justify-end opacity-60 hover:opacity-100 transition">
                  <button @click="openEditExp(exp)" class="text-[10px] text-sky-600 bg-white border border-sky-100 px-2 py-1 rounded">ç·¨è¼¯</button>
                  <button @click="deleteExp(exp)" class="text-[10px] text-red-500 bg-white border border-red-100 px-2 py-1 rounded">åˆªé™¤</button>
                </div>
              </div>
            </div>
          </div>

          <div v-if="filteredExpenses.length===0" class="text-center text-slate-400 py-12 text-sm glass-panel rounded-2xl">å°šç„¡æ¶ˆè²»ç´€éŒ„</div>
        </div>

        <div class="glass-card p-6 mb-8">
          <h3 class="font-bold text-slate-800 mb-4 border-b border-slate-100 pb-2 flex items-center">åˆ†å¸³çµç®—</h3>
          <div v-for="d in debts" :key="d.from + '_' + d.to"
               class="flex justify-between items-center py-3 text-sm border-b border-slate-50 last:border-0">
            <span class="flex items-center gap-2">
              <span class="font-bold text-red-600 bg-red-50 px-2 py-1 rounded border border-red-100">{{d.from}}</span>
              <span class="text-slate-300 font-bold">-></span>
              <span class="font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded border border-emerald-100">{{d.to}}</span>
            </span>
            <span class="font-bold text-slate-800 font-mono text-base">{{ formatNumber(d.amount) }}</span>
          </div>
          <div v-if="debts.length===0" class="text-center text-slate-400 text-xs py-2">ç›®å‰å¤§å®¶éƒ½ä»˜å¾—å‰›å‰›å¥½ï¼Œæ²’æœ‰æ¬ æ¬¾ï¼</div>
        </div>
      </div>
    </Transition>
  </div>

  <!-- Modals (éƒ½åŠ  swipe-protectedï¼Œé¿å…æ‰‹å‹¢å¹²æ“¾) -->
  <div v-if="showRateModal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center z-50 p-6 swipe-protected">
    <div class="glass-card w-full max-w-sm p-6 shadow-2xl bg-white/95">
      <h3 class="font-bold text-xl border-b border-slate-100 pb-3 text-slate-800">åŒ¯ç‡è¨­å®š</h3>
      <p class="text-xs text-slate-500 mt-2 mb-4 font-medium">ä¿®æ”¹å¾Œå°‡è‡ªå‹•é‡ç®—æ‰€æœ‰æ­·å²å¸³ç›®ã€‚</p>
      <div class="grid grid-cols-2 gap-4">
        <div v-for="(rate, cur) in tempRates" :key="cur" v-if="cur !== 'TWD'" class="flex flex-col">
          <label class="text-xs font-bold text-slate-500 mb-1">{{ cur }}</label>
          <input type="number" step="0.01" v-model="tempRates[cur]" class="glass-input p-2 rounded-lg text-center font-mono font-bold">
        </div>
      </div>
      <div class="flex gap-3 pt-6">
        <button @click="showRateModal=false" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-200 transition">å–æ¶ˆ</button>
        <button @click="saveAndRecalculateRates" class="flex-1 btn-glacier py-3 rounded-xl font-bold">å„²å­˜æ›´æ–°</button>
      </div>
    </div>
  </div>

  <div v-if="showItinModal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center z-50 p-4 swipe-protected">
    <div class="glass-card w-full max-w-sm p-6 shadow-2xl bg-white/95 max-h-[90vh] overflow-y-auto">
      <h3 class="font-bold text-xl border-b border-slate-100 pb-3 text-slate-800 mb-4">{{ isEditing ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3>
      <div class="space-y-3">
        <div class="flex gap-2">
          <input v-model="itinForm.startTime" type="time" class="glass-input p-3 rounded-xl w-full">
          <input v-model="itinForm.endTime" type="time" class="glass-input p-3 rounded-xl w-full">
        </div>
        <select v-model="itinForm.category" class="w-full glass-input p-3 rounded-xl font-bold">
          <option value="äº¤é€š">äº¤é€š</option><option value="ä½å®¿">ä½å®¿</option><option value="æ™¯é»">æ™¯é»</option><option value="é£²é£Ÿ">é£²é£Ÿ</option><option value="å…¶ä»–">å…¶ä»–</option>
        </select>
        <input v-model="itinForm.title" placeholder="æ¨™é¡Œ" class="w-full glass-input p-3 rounded-xl">
        <input v-model="itinForm.location" placeholder="åœ°é» / åœ°å€" class="w-full glass-input p-3 rounded-xl">
        <input v-model="itinForm.link" placeholder="ç›¸é—œé€£çµ (é¸å¡«)" class="w-full glass-input p-3 rounded-xl text-sky-600">
        <textarea v-model="itinForm.note" placeholder="å‚™è¨»" class="w-full glass-input p-3 rounded-xl h-24 text-sm"></textarea>
      </div>
      <div class="flex gap-3 pt-6">
        <button @click="showItinModal=false" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-200 transition">å–æ¶ˆ</button>
        <button @click="submitItin" class="flex-1 btn-glacier py-3 rounded-xl font-bold">å„²å­˜</button>
      </div>
    </div>
  </div>

  <div v-if="showExpModal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center z-50 p-4 swipe-protected">
    <div class="glass-card w-full max-w-sm p-6 shadow-2xl bg-white/95">
      <h3 class="font-bold text-xl border-b border-slate-100 pb-3 text-slate-800 mb-4">ç·¨è¼¯æ¶ˆè²»</h3>
      <div class="space-y-3">
        <div class="flex gap-2">
          <select v-model="editExpForm.payer" class="w-1/2 glass-input p-2 rounded-lg text-sm">
            <option>å®¶é½Š</option><option>äº­ç©</option><option>åª½åª½</option>
          </select>
          <select v-model="editExpForm.item" class="w-1/2 glass-input p-2 rounded-lg text-sm">
            <option>æ—©é¤</option><option>åˆé¤</option><option>æ™šé¤</option><option>é›¶é£Ÿ</option><option>ä½å®¿</option>
            <option>äº¤é€šï¼ˆæ©Ÿç¥¨ï¼‰</option><option>äº¤é€šï¼ˆç§Ÿè»Šï¼‰</option><option>äº¤é€šï¼ˆåœè»Šè²»ï¼‰</option><option>äº¤é€šï¼ˆæ²¹éŒ¢ï¼‰</option>
            <option>ç´€å¿µå“</option><option>é–€ç¥¨</option><option>å…¶ä»–</option>
          </select>
        </div>

        <div class="flex gap-2">
          <input type="number" v-model="editExpForm.amount" class="w-1/2 glass-input p-2 rounded-lg text-lg font-mono">
          <select v-model="editExpForm.currency" class="w-1/2 glass-input p-2 rounded-lg font-bold">
            <option>NTD</option><option>NOK</option><option>ISK</option><option>EUR</option><option>GBP</option><option>AED</option>
          </select>
        </div>

        <input v-model="editExpForm.note" placeholder="å‚™è¨»" class="w-full glass-input p-2 rounded-lg text-sm">

        <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
          <div class="text-xs font-bold mb-2 text-slate-400">åˆ†æ”¤å°è±¡</div>
          <div class="flex gap-2 flex-wrap">
            <label v-for="m in members" :key="m"
                   class="flex flex-1 justify-center items-center space-x-1 border px-3 py-1 rounded-full bg-white transition-all"
                   :class="editExpForm.involved.includes(m)?'border-sky-500 text-sky-600 shadow-sm':'border-slate-200 text-slate-400'">
              <input type="checkbox" :value="m" v-model="editExpForm.involved" class="hidden">
              <span class="text-xs font-bold">{{m}}</span>
            </label>
          </div>
        </div>
      </div>

      <div class="flex gap-3 pt-6">
        <button @click="showExpModal=false" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-200 transition">å–æ¶ˆ</button>
        <button @click="submitEditExp" class="flex-1 btn-glacier py-3 rounded-xl font-bold">æ›´æ–°</button>
      </div>
    </div>
  </div>
</div>

<script>
const YOUR_GAS_URL = 'https://script.google.com/macros/s/AKfycbz6PZtqLJzlS2a71R-RfZjpJCuqJVPoP7RuNxEe74mS_uvxBejMNGKboFSn2ArNnXAu/exec';

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(() => console.log('SW registered!'))
      .catch(err => console.log('SW failed', err));
  });
}

async function callApi(action, data = null, method = 'GET') {
  const options = { method };
  if (method === 'POST') {
    options.body = JSON.stringify({ action, data });
    options.headers = { 'Content-Type': 'text/plain;charset=utf-8' };
  }
  let url = YOUR_GAS_URL;
  if (method === 'GET') url += `?action=${action}`;

  const response = await fetch(url, options);
  const ct = response.headers.get("content-type");
  if (ct && ct.indexOf("application/json") === -1) throw new Error("Server HTML Error");
  if (!response.ok) throw new Error("Network error");
  return await response.json();
}

const { createApp, ref, computed, onMounted, nextTick, watch, onBeforeUnmount } = Vue;

createApp({
  setup() {
    const tab = ref('itinerary');
    const isLoading = ref(true);
    const isFirstLoad = ref(true);
    const isPullRefreshing = ref(false);
    const isOnline = ref(navigator.onLine);

    const syncQueue = ref([]);
    const members = ref([]);
    const expenses = ref([]);
    const itinerary = ref([]);
    const rates = ref({});

    const dateContainer = ref(null);
    const scrollContainer = ref(null);

    const todayDate = ref('');
    const todayWeekday = ref('');

    const expandedId = ref(null);
    const toggleExpand = (id) => {
      // å¦‚æœæ­£åœ¨é¸å–æ–‡å­—ï¼Œé¿å…é»æ“Šè§¸ç™¼å±•é–‹
      const sel = window.getSelection();
      if (sel && sel.toString().length > 0) return;

      expandedId.value = (expandedId.value === id) ? null : id;
    };

    const tripStatus = computed(() => {
      const now = new Date();
      const start = new Date('2026-08-30');
      const end = new Date('2026-09-26');
      now.setHours(0,0,0,0); start.setHours(0,0,0,0); end.setHours(0,0,0,0);
      if (now < start) {
        const diff = Math.ceil((start - now) / 86400000);
        return `å€’æ•¸ ${diff} å¤©`;
      } else if (now >= start && now <= end) return 'æ—…ç¨‹ä¸­';
      return 'å›å‘³ç„¡çª®';
    });

    // Trip dates
    const tripDates = [];
    const startDate = new Date('2026-08-30');
    for (let d = new Date(startDate); d <= new Date('2026-09-26'); d.setDate(d.getDate() + 1)) {
      tripDates.push({ date: d.toISOString().split('T')[0], short: (d.getMonth()+1) + '/' + d.getDate() });
    }
    const selDate = ref(tripDates[0].date);
    const filterDate = ref('ALL');

    // Modals
    const showItinModal = ref(false);
    const showExpModal = ref(false);
    const showRateModal = ref(false);
    const isEditing = ref(false);

    const itinForm = ref({ row: null, startTime: '09:00', endTime: '', category: 'æ™¯é»', title: '', location: '', link: '', note: '' });
    const newExp = ref({ payer: '', location: '', item: '', payment: '', currency: 'NTD', amount: null, involved: [], note: '' });

    watch(() => newExp.value.payer, (newVal) => {
      if (newVal) newExp.value.involved = [newVal];
    });

    const editExpForm = ref({});
    const tempRates = ref({});
    let chartInstance = null;

    // Pull to refresh UI
    const pullDistance = ref(0);
    const refreshText = computed(() => isPullRefreshing.value ? 'æ›´æ–°ä¸­...' : 'ä¸‹æ‹‰æ›´æ–°');

    // =========================================================
    // iOS FRIENDLY GESTURE ENGINE (non-passive listeners)
    // =========================================================
    const gesture = {
      active: false,
      blocked: false,
      mode: null,           // 'h' | 'v'
      startX: 0,
      startY: 0,
      lastX: 0,
      lastY: 0,
      dx: 0,
      dy: 0,
      startedAtLeftEdge: false,
    };

    const isSelectableTarget = (target) => {
      // ä»»ä½•å¯è¼¸å…¥/å¯äº’å‹•æ§ä»¶éƒ½ä¸è¦æ¥ç®¡
      if (target.closest('.allow-select')) return true;
      if (target.closest('.swipe-protected')) return true;
      const tag = (target.tagName || '').toLowerCase();
      if (['input','textarea','select','button','a','label'].includes(tag)) return true;
      return false;
    };

    const hasTextSelection = () => {
      const sel = window.getSelection();
      return !!(sel && sel.toString && sel.toString().length > 0);
    };

    const attachGestureListeners = () => {
      const el = scrollContainer.value;
      if (!el) return;

      const onTouchStart = (e) => {
        const t = e.touches[0];
        gesture.active = true;
        gesture.mode = null;
        gesture.dx = 0;
        gesture.dy = 0;
        gesture.startX = t.clientX;
        gesture.startY = t.clientY;
        gesture.lastX = t.clientX;
        gesture.lastY = t.clientY;

        // iOS å·¦é‚Šç·£å‘å³æ»‘é€šå¸¸æ˜¯ã€Œè¿”å›ã€ï¼šæˆ‘å€‘ä¸æ””
        gesture.startedAtLeftEdge = (gesture.startX <= 18);

        gesture.blocked = isSelectableTarget(e.target);
      };

      const onTouchMove = (e) => {
        if (!gesture.active) return;
        if (gesture.blocked) return;

        // ä¸€æ—¦å·²æœ‰é¸å–æ–‡å­—ï¼Œæ•´æ®µæ‰‹å‹¢æ”¾è¡Œï¼Œé¿å…è¤‡è£½é¸å–®æ¶ˆå¤±
        if (hasTextSelection()) return;

        const t = e.touches[0];
        gesture.dx = t.clientX - gesture.startX;
        gesture.dy = t.clientY - gesture.startY;
        gesture.lastX = t.clientX;
        gesture.lastY = t.clientY;

        const absX = Math.abs(gesture.dx);
        const absY = Math.abs(gesture.dy);

        // å°ä½ç§»ä¸åˆ¤å®š
        if (!gesture.mode) {
          if (absX < 10 && absY < 10) return;
          gesture.mode = (absX > absY) ? 'h' : 'v';
        }

        // æ°´å¹³æ‰‹å‹¢ï¼šç”¨ä¾†æ›æ—¥æœŸï¼ˆåªåœ¨ itineraryï¼‰
        if (gesture.mode === 'h') {
          // ä¸å¹²æ“¾ iOS edge-back
          if (gesture.startedAtLeftEdge && gesture.dx > 0) return;

          // æˆ‘å€‘è¦é˜»æ­¢å‚ç›´æ»¾å‹•åœ¨æ°´å¹³ swipe æ™‚æ™ƒå‹•
          if (e.cancelable) e.preventDefault();
          return;
        }

        // å‚ç›´æ‰‹å‹¢ï¼šåªåœ¨æœ€é ‚éƒ¨ä¸‹æ‹‰æ‰æ¥ç®¡ï¼ˆPull-to-refreshï¼‰
        if (gesture.mode === 'v') {
          const scroller = scrollContainer.value;
          const isTop = scroller ? scroller.scrollTop <= 0 : true;
          if (isTop && gesture.dy > 0) {
            if (e.cancelable) e.preventDefault();
            // å¹³æ»‘ä¸€é»
            pullDistance.value = Math.min(72, Math.pow(gesture.dy, 0.7));
          }
        }
      };

      const onTouchEnd = () => {
        if (!gesture.active) return;
        gesture.active = false;

        // æœ‰é¸å–æ–‡å­—æ™‚ï¼šçµ•å°ä¸åšä»»ä½• swipe/pull è¡Œç‚º
        if (hasTextSelection()) {
          pullDistance.value = 0;
          return;
        }

        // Pull to refresh
        if (pullDistance.value > 60) {
          pullDistance.value = 60;
          isPullRefreshing.value = true;
          loadData();
          return;
        } else {
          pullDistance.value = 0;
        }

        // Horizontal swipe -> switch day (only in itinerary)
        if (gesture.mode === 'h' && tab.value === 'itinerary') {
          const absX = Math.abs(gesture.dx);
          const absY = Math.abs(gesture.dy);
          if (absX > 60 && absX > absY) {
            if (gesture.dx < 0) switchDay('next');
            else switchDay('prev');
          }
        }

        gesture.mode = null;
      };

      // ä¿å­˜å¼•ç”¨ä»¥ä¾¿ç§»é™¤
      attachGestureListeners._handlers = { onTouchStart, onTouchMove, onTouchEnd };

      // iOS é—œéµï¼špassive:false
      el.addEventListener('touchstart', onTouchStart, { passive: true });   // start ä¸éœ€ preventDefault
      el.addEventListener('touchmove',  onTouchMove,  { passive: false });  // move æœƒ preventDefault
      el.addEventListener('touchend',   onTouchEnd,   { passive: true });
      el.addEventListener('touchcancel',onTouchEnd,   { passive: true });
    };

    const detachGestureListeners = () => {
      const el = scrollContainer.value;
      const h = attachGestureListeners._handlers;
      if (!el || !h) return;
      el.removeEventListener('touchstart', h.onTouchStart);
      el.removeEventListener('touchmove',  h.onTouchMove);
      el.removeEventListener('touchend',   h.onTouchEnd);
      el.removeEventListener('touchcancel',h.onTouchEnd);
      attachGestureListeners._handlers = null;
    };

    // =========================================================
    // Online / Offline
    // =========================================================
    window.addEventListener('online', () => { isOnline.value = true; processSyncQueue(); });
    window.addEventListener('offline', () => { isOnline.value = false; });

    const initDate = () => {
      const now = new Date();
      todayDate.value = now.getFullYear() + '.' + String(now.getMonth()+1).padStart(2,'0') + '.' + String(now.getDate()).padStart(2,'0');
      const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      todayWeekday.value = days[now.getDay()];
    };

    // =========================================================
    // Data / Cache
    // =========================================================
    const saveLocal = (data) => {
      try {
        localStorage.setItem('tripData_v35', JSON.stringify(data));
        localStorage.setItem('syncQueue_v35', JSON.stringify(syncQueue.value));
      } catch (e) { console.error('Cache failed', e); }
    };

    const loadLocal = () => {
      const data = localStorage.getItem('tripData_v35');
      const q = localStorage.getItem('syncQueue_v35');
      if (q) syncQueue.value = JSON.parse(q);
      if (data) {
        const parsed = JSON.parse(data);
        expenses.value = parsed.expenses || [];
        itinerary.value = parsed.itinerary || [];
        members.value = parsed.members || [];
        rates.value = parsed.rates || {};
        return true;
      }
      return false;
    };

    const loadData = async () => {
      if (!isPullRefreshing.value) isLoading.value = true;

      // å…ˆç”¨ cache æå‡é«”é©—
      if (loadLocal()) {
        if (isFirstLoad.value) {
          nextTick(() => { checkAndScrollToToday(); });
          isFirstLoad.value = false;
        }
        if (tab.value === 'analysis') changeTabToAnalysis();
        setTimeout(() => { if (!isPullRefreshing.value) isLoading.value = false; }, 200);
      }

      if (!isOnline.value) {
        isLoading.value = false;
        isPullRefreshing.value = false;
        pullDistance.value = 0;
        return;
      }

      try {
        const res = await callApi('getData');
        if (res && res.expenses) {
          expenses.value = res.expenses;
          itinerary.value = res.itinerary;
          members.value = res.members;
          rates.value = res.rates;
          saveLocal(res);
          if (tab.value === 'analysis') changeTabToAnalysis();
        }
      } catch (e) {
        console.error(e);
      } finally {
        isLoading.value = false;
        isPullRefreshing.value = false;
        pullDistance.value = 0;
      }
    };

    // =========================================================
    // Sync Queue
    // =========================================================
    const processSyncQueue = async () => {
      if (syncQueue.value.length === 0 || !navigator.onLine) return;

      const queue = [...syncQueue.value];
      let successCount = 0;

      for (let i = 0; i < queue.length; i++) {
        try {
          await callApi(queue[i].action, queue[i].data, 'POST');
          successCount++;
        } catch (e) {
          if (String(e).includes('Failed to fetch')) break;
          successCount++;
        }
      }

      syncQueue.value.splice(0, successCount);
      saveLocal({ expenses: expenses.value, itinerary: itinerary.value, members: members.value, rates: rates.value });
    };

    const forceClearSync = () => {
      if (confirm('æ¸…é™¤æœªä¸Šå‚³çš„ä½‡åˆ—ï¼Ÿ')) {
        syncQueue.value = [];
        saveLocal({ expenses: expenses.value, itinerary: itinerary.value, members: members.value, rates: rates.value });
        window.location.reload();
      }
    };

    const handleAction = (actionName, payload, localUpdateFunc) => {
      localUpdateFunc();
      syncQueue.value.push({ action: actionName, data: payload, timestamp: Date.now() });
      saveLocal({ expenses: expenses.value, itinerary: itinerary.value, members: members.value, rates: rates.value });
      if (navigator.onLine) processSyncQueue();
    };

    // =========================================================
    // Expense CRUD
    // =========================================================
    const submitExp = () => {
      if (!newExp.value.amount || !newExp.value.payer || !newExp.value.item) { alert('è«‹å¡«å¯«å®Œæ•´'); return; }
      if (newExp.value.involved.length === 0) { alert('è‡³å°‘é¸ä¸€ä½åˆ†æ”¤è€…'); return; }

      const currentRate = rates.value[newExp.value.currency] || 1;
      const amtTWD = Math.round(newExp.value.amount * currentRate);
      const data = { ...newExp.value, amountTWD: amtTWD };

      handleAction('addExpense', data, () => {
        const tempItem = {
          ...data,
          row: 'temp_' + Date.now(),
          date: new Date().toISOString().split('T')[0],
          time: 'å‰›å‰›',
          isPending: true
        };
        expenses.value.unshift(tempItem);
        newExp.value.amount = null;
        newExp.value.note = '';
      });
    };

    const submitEditExp = () => {
      const currentRate = rates.value[editExpForm.value.currency] || 1;
      editExpForm.value.amountTWD = Math.round(editExpForm.value.amount * currentRate);
      const data = { ...editExpForm.value };

      handleAction('editExpense', data, () => {
        const idx = expenses.value.findIndex(e => e.row === data.row);
        if (idx !== -1) expenses.value[idx] = { ...expenses.value[idx], ...data, isPending: true };
        showExpModal.value = false;
      });
    };

    const deleteExp = (exp) => {
      if (!confirm('åˆªé™¤æ­¤ç­†æ¶ˆè²»ï¼Ÿ')) return;

      if (String(exp.row).startsWith('temp_')) {
        expenses.value = expenses.value.filter(e => e.row !== exp.row);
        syncQueue.value = syncQueue.value.filter(q => !(q.action === 'addExpense' && q.data.item === exp.item && q.data.amount === exp.amount));
        saveLocal({ expenses: expenses.value, itinerary: itinerary.value, members: members.value, rates: rates.value });
        return;
      }

      handleAction('deleteRow', { sheetName: 'Expenses', row: exp.row }, () => {
        expenses.value = expenses.value.filter(e => e.row !== exp.row);
      });
    };

    // =========================================================
    // Itinerary CRUD
    // =========================================================
    const submitItin = () => {
      if (!itinForm.value.title) return;

      const data = { ...itinForm.value, date: selDate.value };

      if (isEditing.value) {
        handleAction('editItinerary', data, () => {
          const idx = itinerary.value.findIndex(e => e.row === data.row);
          if (idx !== -1) itinerary.value[idx] = { ...itinerary.value[idx], ...data, isPending: true };
          showItinModal.value = false;
        });
      } else {
        handleAction('addItinerary', data, () => {
          itinerary.value.push({ ...data, row: 'temp_' + Date.now(), isPending: true });
          showItinModal.value = false;
        });
      }
    };

    const deleteItin = (evt) => {
      if (!confirm('åˆªé™¤è¡Œç¨‹ï¼Ÿ')) return;

      if (String(evt.row).startsWith('temp_')) {
        itinerary.value = itinerary.value.filter(e => e.row !== evt.row);
        syncQueue.value = syncQueue.value.filter(q => !(q.action === 'addItinerary' && q.data.title === evt.title));
        saveLocal({ expenses: expenses.value, itinerary: itinerary.value, members: members.value, rates: rates.value });
        return;
      }

      handleAction('deleteRow', { sheetName: 'Itinerary', row: evt.row }, () => {
        itinerary.value = itinerary.value.filter(e => e.row !== evt.row);
      });
    };

    // =========================================================
    // Rate
    // =========================================================
    const saveAndRecalculateRates = () => {
      if (!confirm('ç¢ºå®šæ›´æ–°åŒ¯ç‡ï¼Ÿ')) return;

      isLoading.value = true;
      callApi('updateRates', tempRates.value, 'POST')
        .then(res => {
          expenses.value = res.expenses;
          rates.value = res.rates;
          saveLocal(res);
          showRateModal.value = false;
          isLoading.value = false;
          if (tab.value === 'analysis') changeTabToAnalysis();
        })
        .catch(() => { isLoading.value = false; });
    };

    // =========================================================
    // Helpers
    // =========================================================
    const openRateModal = () => { tempRates.value = { ...rates.value }; showRateModal.value = true; };
    const openEditExp = (exp) => { editExpForm.value = JSON.parse(JSON.stringify(exp)); showExpModal.value = true; };

    const openEditItin = (evt) => { isEditing.value = true; itinForm.value = { ...evt }; showItinModal.value = true; };
    const openAddItin = () => {
      isEditing.value = false;
      itinForm.value = { row: null, startTime: '09:00', endTime: '', category: 'æ™¯é»', title: '', location: '', link: '', note: '' };
      showItinModal.value = true;
    };

    const toggleSelectAll = () => {
      newExp.value.involved = (newExp.value.involved.length === members.value.length) ? [] : [...members.value];
    };

    const selectDate = (date) => { selDate.value = date; scrollToDateBtn(date); };

    const scrollToDateBtn = (date) => {
      nextTick(() => {
        const btn = document.getElementById('date-btn-' + date);
        if (btn && dateContainer.value) {
          const centerPos = (btn.offsetLeft - dateContainer.value.offsetLeft) - (dateContainer.value.clientWidth / 2) + (btn.clientWidth / 2);
          dateContainer.value.scrollTo({ left: centerPos, behavior: 'smooth' });
        }
      });
    };

    const checkAndScrollToToday = () => {
      const d = new Date(); const offset = d.getTimezoneOffset() * 60000;
      const todayStr = new Date(d.getTime() - offset).toISOString().split('T')[0];
      if (tripDates.some(x => x.date === todayStr)) {
        selDate.value = todayStr;
        scrollToDateBtn(todayStr);
      } else {
        selDate.value = tripDates[0].date;
        scrollToDateBtn(tripDates[0].date);
      }
    };

    const switchDay = (direction) => {
      const idx = tripDates.findIndex(d => d.date === selDate.value);
      if (direction === 'next' && idx < tripDates.length - 1) selectDate(tripDates[idx + 1].date);
      if (direction === 'prev' && idx > 0) selectDate(tripDates[idx - 1].date);
    };

    const getCategoryClass = (cat) => {
      switch (cat) {
        case 'äº¤é€š': return 'cat-traffic';
        case 'ä½å®¿': return 'cat-stay';
        case 'æ™¯é»': return 'cat-spot';
        case 'é£²é£Ÿ': return 'cat-food';
        default: return 'cat-note';
      }
    };

    const getDayInfo = (dStr) => {
      const d = new Date(dStr);
      const diff = Math.ceil((d - startDate) / 86400000) + 1;
      return `DAY ${diff} Â· ${['é€±æ—¥','é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­'][d.getDay()]}`;
    };

    const getEvents = (d) => itinerary.value.filter(e => e.date === d).sort((a, b) => a.startTime.localeCompare(b.startTime));
    const formatNumber = (n) => String(n).replace(/\B(?=(\d{3})+(?!\d))/g, ",");

    const uniqueExpDates = computed(() => [...new Set(expenses.value.map(e => e.date))].sort());
    const filteredExpenses = computed(() => (filterDate.value === 'ALL') ? expenses.value : expenses.value.filter(e => e.date === filterDate.value));

    const getAmountTWD = (exp) => {
      if (exp.amountTWD && exp.amountTWD > 0) return exp.amountTWD;
      return Math.round(exp.amount * (rates.value[exp.currency] || 1));
    };

    const publicSpent = computed(() => {
      return expenses.value.reduce((sum, e) => {
        const amt = getAmountTWD(e);
        if (!e.involved || e.involved.length === 0) return sum;
        const perShare = amt / e.involved.length;
        let bill = 0;
        if (e.involved.includes('å®¶é½Š')) bill += perShare;
        if (e.involved.includes('äº­ç©')) bill += perShare;
        return sum + bill;
      }, 0);
    });

    const momSpent = computed(() => {
      return expenses.value.reduce((sum, e) => {
        const amt = getAmountTWD(e);
        if (e.involved && e.involved.includes('åª½åª½')) return sum + (amt / e.involved.length);
        return sum;
      }, 0);
    });

    const debts = computed(() => {
      if (members.value.length === 0) return [];
      const bal = {};
      members.value.forEach(m => bal[m] = 0);

      expenses.value.forEach(e => {
        const amt = getAmountTWD(e);
        const split = e.involved || [];
        if (split.length > 0) {
          bal[e.payer] += amt;
          const share = amt / split.length;
          split.forEach(p => { if (bal[p] !== undefined) bal[p] -= share; });
        }
      });

      let debtors = [], creditors = [];
      for (const m in bal) {
        if (bal[m] < -1) debtors.push({ p: m, a: bal[m] });
        if (bal[m] > 1) creditors.push({ p: m, a: bal[m] });
      }
      debtors.sort((a,b) => a.a - b.a);
      creditors.sort((a,b) => b.a - a.a);

      const res = [];
      let i = 0, j = 0;
      while (i < debtors.length && j < creditors.length) {
        const d = debtors[i], c = creditors[j];
        const amt = Math.min(Math.abs(d.a), c.a);
        res.push({ from: d.p, to: c.p, amount: Math.round(amt) });
        d.a += amt; c.a -= amt;
        if (Math.abs(d.a) < 1) i++;
        if (c.a < 1) j++;
      }
      return res;
    });

    // Chart
    const renderChart = () => {
      const ctx = document.getElementById('expenseChart');
      if (!ctx) return;

      const stats = {};
      filteredExpenses.value.forEach(e => {
        if (!stats[e.item]) stats[e.item] = 0;
        stats[e.item] += getAmountTWD(e);
      });

      const nordicColors = ['#38bdf8', '#818cf8', '#c084fc', '#f472b6', '#fb7185', '#22d3ee', '#34d399', '#a78bfa', '#fbcfe8', '#e2e8f0'];
      if (chartInstance) chartInstance.destroy();

      chartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: Object.keys(stats), datasets: [{ data: Object.values(stats), backgroundColor: nordicColors, borderWidth: 0, hoverOffset: 4 }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '70%',
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                font: { family: 'Inter', size: 11, weight: 'bold' },
                color: '#64748b',
                usePointStyle: true,
                padding: 15,
                boxWidth: 8
              }
            }
          }
        }
      });
    };

    const changeTabToAnalysis = () => {
      tab.value = 'analysis';
      setTimeout(() => renderChart(), 250);
    };

    watch(filterDate, () => { if (tab.value === 'analysis') renderChart(); });

    // =========================================================
    // Lifecycle
    // =========================================================
    onMounted(async () => {
      initDate();
      await nextTick();
      attachGestureListeners();   // âœ… iOS non-passive touch listeners
      loadData();
    });

    onBeforeUnmount(() => {
      detachGestureListeners();
    });

    // =========================================================
    // Expose to template
    // =========================================================
    return {
      tab, isLoading, members, expenses, itinerary, rates, tripDates, selDate, filterDate,
      showItinModal, showExpModal, showRateModal, isEditing,
      itinForm, newExp, editExpForm, tempRates,
      dateContainer, scrollContainer,
      pullDistance, isPullRefreshing, refreshText,
      todayDate, todayWeekday, isOnline, syncQueue,
      tripStatus, publicSpent, momSpent,

      // funcs
      toggleExpand, expandedId,
      selectDate, getDayInfo, getEvents, getCategoryClass,
      openAddItin, openEditItin, submitItin, deleteItin,
      submitExp, openEditExp, submitEditExp, deleteExp,
      toggleSelectAll,
      openRateModal, saveAndRecalculateRates,
      processSyncQueue, forceClearSync,
      changeTabToAnalysis, renderChart,
      formatNumber, getAmountTWD, uniqueExpDates, filteredExpenses, debts
    };
  }
}).mount('#app');
</script>
</body>
</html>
